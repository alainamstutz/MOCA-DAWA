<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="A.Amstutz">

<title>MOCA/DAWA cluster randomized trial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="MOCA-DAWA_files/libs/clipboard/clipboard.min.js"></script>
<script src="MOCA-DAWA_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="MOCA-DAWA_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="MOCA-DAWA_files/libs/quarto-html/popper.min.js"></script>
<script src="MOCA-DAWA_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="MOCA-DAWA_files/libs/quarto-html/anchor.min.js"></script>
<link href="MOCA-DAWA_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="MOCA-DAWA_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="MOCA-DAWA_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="MOCA-DAWA_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="MOCA-DAWA_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="MOCA-DAWA_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="MOCA-DAWA_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#dawa-cluster-randomized-trial-crt" id="toc-dawa-cluster-randomized-trial-crt" class="nav-link active" data-scroll-target="#dawa-cluster-randomized-trial-crt"><strong>DAWA cluster randomized trial (CRT)</strong></a>
  <ul>
  <li><a href="#parameters-and-design-considerations" id="toc-parameters-and-design-considerations" class="nav-link" data-scroll-target="#parameters-and-design-considerations"><strong>Parameters and design considerations</strong></a></li>
  <li><a href="#corresponding-individual-randomized-trial" id="toc-corresponding-individual-randomized-trial" class="nav-link" data-scroll-target="#corresponding-individual-randomized-trial"><strong>Corresponding individual randomized trial</strong></a></li>
  </ul></li>
  <li><a href="#sample-size-calculation-crt-formula-based" id="toc-sample-size-calculation-crt-formula-based" class="nav-link" data-scroll-target="#sample-size-calculation-crt-formula-based"><strong>(1) Sample size calculation CRT: formula-based</strong></a>
  <ul>
  <li><a href="#varying-assumptions---standard-sample-size-calculation" id="toc-varying-assumptions---standard-sample-size-calculation" class="nav-link" data-scroll-target="#varying-assumptions---standard-sample-size-calculation"><strong>(1.1) Varying assumptions - Standard sample size calculation</strong></a>
  <ul class="collapse">
  <li><a href="#varying-baseline-control-rate" id="toc-varying-baseline-control-rate" class="nav-link" data-scroll-target="#varying-baseline-control-rate"><strong>(1.1.1) Varying baseline control rate</strong></a></li>
  <li><a href="#varying-icc" id="toc-varying-icc" class="nav-link" data-scroll-target="#varying-icc"><strong>(1.1.2) Varying ICC</strong></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sample-size-calculation-crt-simulations" id="toc-sample-size-calculation-crt-simulations" class="nav-link" data-scroll-target="#sample-size-calculation-crt-simulations"><strong>(2) Sample size calculation CRT: Simulations</strong></a>
  <ul>
  <li><a href="#parameters" id="toc-parameters" class="nav-link" data-scroll-target="#parameters"><strong>(2.1) Parameters</strong></a></li>
  <li><a href="#create-main-functions-and-simulate-one-dataset" id="toc-create-main-functions-and-simulate-one-dataset" class="nav-link" data-scroll-target="#create-main-functions-and-simulate-one-dataset"><strong>(2.2) Create main functions and simulate one dataset</strong></a></li>
  <li><a href="#simulate-power-using-cluster-level-analysis-approach" id="toc-simulate-power-using-cluster-level-analysis-approach" class="nav-link" data-scroll-target="#simulate-power-using-cluster-level-analysis-approach"><strong>(2.3) Simulate power, using cluster-level analysis approach</strong></a>
  <ul class="collapse">
  <li><a href="#create-function" id="toc-create-function" class="nav-link" data-scroll-target="#create-function"><strong>(2.3.1) Create function</strong></a></li>
  <li><a href="#calculate-baseline-scenario" id="toc-calculate-baseline-scenario" class="nav-link" data-scroll-target="#calculate-baseline-scenario"><strong>(2.3.2)</strong> Calculate baseline scenario</a></li>
  <li><a href="#vary-effect-sizes" id="toc-vary-effect-sizes" class="nav-link" data-scroll-target="#vary-effect-sizes"><strong>(2.3.3) Vary effect sizes</strong></a></li>
  <li><a href="#vary-icc" id="toc-vary-icc" class="nav-link" data-scroll-target="#vary-icc"><strong>(2.3.4) Vary ICC</strong></a></li>
  <li><a href="#vary-number-of-clusters" id="toc-vary-number-of-clusters" class="nav-link" data-scroll-target="#vary-number-of-clusters"><strong>(2.3.5) Vary number of clusters</strong></a></li>
  <li><a href="#vary-number-of-individuals-per-cluster-mean-cluster-size" id="toc-vary-number-of-individuals-per-cluster-mean-cluster-size" class="nav-link" data-scroll-target="#vary-number-of-individuals-per-cluster-mean-cluster-size"><strong>(2.3.6) Vary number of individuals per cluster (mean cluster size)</strong></a></li>
  </ul></li>
  <li><a href="#simulate-power-using-glmm-analysis-approach" id="toc-simulate-power-using-glmm-analysis-approach" class="nav-link" data-scroll-target="#simulate-power-using-glmm-analysis-approach"><strong>(2.4) Simulate power, using GLMM analysis approach</strong></a>
  <ul class="collapse">
  <li><a href="#create-function-1" id="toc-create-function-1" class="nav-link" data-scroll-target="#create-function-1"><strong>(2.4.1) Create function</strong></a></li>
  <li><a href="#calculate-baseline-scenario-1" id="toc-calculate-baseline-scenario-1" class="nav-link" data-scroll-target="#calculate-baseline-scenario-1"><strong>(2.4.2)</strong> Calculate baseline scenario</a></li>
  <li><a href="#vary-effect-sizes-1" id="toc-vary-effect-sizes-1" class="nav-link" data-scroll-target="#vary-effect-sizes-1"><strong>(2.4.3) Vary effect sizes</strong></a></li>
  <li><a href="#vary-icc-1" id="toc-vary-icc-1" class="nav-link" data-scroll-target="#vary-icc-1"><strong>(2.4.4) Vary ICC</strong></a></li>
  <li><a href="#vary-number-of-clusters-1" id="toc-vary-number-of-clusters-1" class="nav-link" data-scroll-target="#vary-number-of-clusters-1"><strong>(2.4.5) Vary number of clusters</strong></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#simulate-the-full-dataset-and-implement-the-main-analysis-strategy" id="toc-simulate-the-full-dataset-and-implement-the-main-analysis-strategy" class="nav-link" data-scroll-target="#simulate-the-full-dataset-and-implement-the-main-analysis-strategy"><strong>(3) Simulate the full dataset and implement the main analysis strategy</strong></a>
  <ul>
  <li><a href="#simulate-one-dataset-and-check-some-diagnostics" id="toc-simulate-one-dataset-and-check-some-diagnostics" class="nav-link" data-scroll-target="#simulate-one-dataset-and-check-some-diagnostics"><strong>(3.1) Simulate one dataset and check some diagnostics</strong></a></li>
  <li><a href="#the-analysis-approach-step-by-step" id="toc-the-analysis-approach-step-by-step" class="nav-link" data-scroll-target="#the-analysis-approach-step-by-step"><strong>(3.2) The analysis approach, step-by-step</strong></a></li>
  <li><a href="#put-all-together-and-simulate-the-power" id="toc-put-all-together-and-simulate-the-power" class="nav-link" data-scroll-target="#put-all-together-and-simulate-the-power"><strong>(3.3) Put all together and simulate the power</strong></a></li>
  </ul></li>
  <li><a href="#minimization-algorithm-for-stratified-randomization" id="toc-minimization-algorithm-for-stratified-randomization" class="nav-link" data-scroll-target="#minimization-algorithm-for-stratified-randomization"><strong>(4) Minimization algorithm for stratified randomization</strong></a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="MOCA-DAWA.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">MOCA/DAWA cluster randomized trial</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>A.Amstutz </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="dawa-cluster-randomized-trial-crt" class="level1">
<h1><strong>DAWA cluster randomized trial (CRT)</strong></h1>
<p>Interventions on the level of health care workers at health facilities (dispensaries) in Zanzibar to reduce antibiotic prescriptions. Multi-arm with 2 interventions:</p>
<ul>
<li><p><strong>Control</strong>: Standard of care</p></li>
<li><p><strong>Intervention 1</strong>: eHealth tool (CDSS &amp; nudging)</p></li>
<li><p><strong>Intervention 2</strong>: eHealth tool (CDSS &amp; nudging) + AMR stewardship clubs</p></li>
</ul>
<section id="parameters-and-design-considerations" class="level2">
<h2 class="anchored" data-anchor-id="parameters-and-design-considerations"><strong>Parameters and design considerations</strong></h2>
<ul>
<li><p>Eligible participants: Patients attending the dispensary with acute infectious illness</p></li>
<li><p>Power it for subgroup of kids under 5 years (special subgroup of interest), ca. 33% of all attending patients with acute infectious illness</p></li>
<li><p>Cluster size of eligible overall participants: 80-500 per cluster per month</p></li>
<li><p>Cluster size of eligible kids under 5 years (special subgroup of interest): 26-165 per cluster per month</p></li>
<li><p>Max. 39 clusters, i.e.&nbsp;max. 13 clusters per arm, due to feasibility/budget</p></li>
<li><p>Binary outcome: Proportion of patients prescribed an antibiotic at first presentation</p></li>
<li><p>Baseline prescription rate (control clusters): 75%, based on existing data</p></li>
<li><p>Expected delta Control to Intervention 1: 25 percentage points, based on prior evidence</p></li>
<li><p>Expected delta Control to Intervention 2: 30 percentage points</p></li>
<li><p>Intervention 1 vs Intervention 2 is not of primary interest</p></li>
<li><p>Min. desired power 80%</p></li>
<li><p>ICC for AB prescription: 0.20, based on prior evidence in same setting (but mainland TZ)</p></li>
<li><p>We expect the intervention effect to manifest 3-4 months after baseline</p></li>
<li><p>Important feasibility aspect: The primary outcome is collected through routine data, while the key secondary outcomes are collected via phone calls</p></li>
<li><p>CV (coefficient of variation), ratio of standard deviation of cluster sizes to mean of cluster sizes</p></li>
<li><p>Since we have flexibility in individual sample size per cluster and need to restrict it anyway to keep the data collection for the key secondary outcomes feasible, we decided to take a random sample from each cluster, same n, which will reduce the CV. Moreover, we will stratify the randomization and adjust the outcome model for actual cluster size (attendance rate)</p></li>
<li><p>An individual sample size per cluster (i.e.&nbsp;mean cluster size) of n=150 will be feasible to recruit during 2 months (month 4 and 5 after baseline, when effect of intervention kicks in) from each cluster, using a random sampling strategy. N=150/cluster means we will get n=40/cluster kids under 5, for which we power the sample size. And we can safely assume a minimal CV of 0.1</p></li>
<li><p>Recruitment bias? -&gt; see protocol how to mitigate</p></li>
<li><p>Multiplicity? -&gt; see separate discussion. Decision: No adjustment for multiplicity</p></li>
</ul>
<p><strong>Packages</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>req_pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pwr"</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>              <span class="st">"dplyr"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">"purrr"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>              <span class="st">"ggplot2"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>              <span class="st">"lme4"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>              <span class="st">"geepack"</span>, <span class="co"># for GEE (if needed)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>              <span class="st">"MASS"</span>, <span class="co"># for GLMM PQL</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"marginaleffects"</span>, <span class="co"># for marginal standardization</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>              <span class="st">"future"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>              <span class="st">"future.apply"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>              <span class="st">"nlme"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>              <span class="st">"tibble"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>              <span class="st">"knitr"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">"kableExtra"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>              <span class="st">"splines"</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>install_if_missing <span class="ot">&lt;-</span> <span class="cf">function</span>(pkgs){</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(p <span class="cf">in</span> pkgs){</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">requireNamespace</span>(p, <span class="at">quietly=</span><span class="cn">TRUE</span>)){</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">install.packages</span>(p, <span class="at">repos=</span><span class="st">"https://cloud.r-project.org"</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(p, <span class="at">character.only=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="fu">install_if_missing</span>(req_pkgs)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># set global RNG seed for reproducibility</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20250809</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="corresponding-individual-randomized-trial" class="level2">
<h2 class="anchored" data-anchor-id="corresponding-individual-randomized-trial"><strong>Corresponding individual randomized trial</strong></h2>
<p>Sample size for the individual randomized trial on the same question</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>p_C <span class="ot">&lt;-</span> <span class="fl">0.75</span> <span class="co"># Baseline prescription rate (control group)</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>p_I1 <span class="ot">&lt;-</span> <span class="fl">0.50</span> <span class="co"># int 1: 25pp reduction</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>p_I2 <span class="ot">&lt;-</span> <span class="fl">0.45</span> <span class="co"># int 2: 30pp reduction</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>power <span class="ot">&lt;-</span> <span class="fl">0.80</span> <span class="co"># desired power</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span> <span class="co"># do not apply any (bonferroni) correction for multiplicity (see separate discussion)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Effect sizes, standardized as Cohen's h</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>h_I1_C <span class="ot">&lt;-</span> <span class="fu">ES.h</span>(<span class="at">p1 =</span> p_I1, <span class="at">p2 =</span> p_C)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>h_I2_C <span class="ot">&lt;-</span> <span class="fu">ES.h</span>(<span class="at">p1 =</span> p_I2, <span class="at">p2 =</span> p_C)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cohen's h for I1 vs Control:"</span>, <span class="fu">round</span>(h_I1_C, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cohen's h for I1 vs Control: -0.524 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cohen's h for I2 vs Control:"</span>, <span class="fu">round</span>(h_I2_C, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cohen's h for I2 vs Control: -0.624 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =&gt; reduction of mind. 25% is a Cohen's h of over 0.5 -&gt; medium to large effect according to Cohen</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample size first pair-wise comparison (I1 vs C)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>ss_I1_C <span class="ot">&lt;-</span> <span class="fu">pwr.2p.test</span>(<span class="at">h =</span> h_I1_C, <span class="at">sig.level =</span> alpha, <span class="at">power =</span> power)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample size per arm (I1 vs C):"</span>, <span class="fu">ceiling</span>(ss_I1_C<span class="sc">$</span>n), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Sample size per arm (I1 vs C): 58 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample size second pair-wise comparison (I2 vs C)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ss_I2_C <span class="ot">&lt;-</span> <span class="fu">pwr.2p.test</span>(<span class="at">h =</span> h_I2_C, <span class="at">sig.level =</span> alpha, <span class="at">power =</span> power)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample size per arm (I2 vs C):"</span>, <span class="fu">ceiling</span>(ss_I2_C<span class="sc">$</span>n), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Sample size per arm (I2 vs C): 41 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use max of the two</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>n_per_arm <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">ceiling</span>(ss_I1_C<span class="sc">$</span>n), <span class="fu">ceiling</span>(ss_I2_C<span class="sc">$</span>n))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>n_total <span class="ot">&lt;-</span> n_per_arm <span class="sc">*</span> <span class="dv">3</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample size per arm:"</span>, n_per_arm, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Sample size per arm: 58 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total sample size (3-arm trial):"</span>, n_total)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total sample size (3-arm trial): 174</code></pre>
</div>
</div>
<p>A reduction of at least 25% percentage points (the smaller delta of the two) represents a Cohen’s h of &gt;0.5 =&gt; medium to large effect</p>
</section>
</section>
<section id="sample-size-calculation-crt-formula-based" class="level1">
<h1><strong>(1) Sample size calculation CRT: formula-based</strong></h1>
<p>Add the design effect (DEFF) to the individual RCT sample size. The usual standard DEFF formula:</p>
<p>DEFF = 1+(m−1)ICC , whereby m = cluster size</p>
<p>However, let’s not forget the cluster size variation. The usual conservative adjustment of the DEFF with cluster size variation is (e.g.&nbsp;see here: <a href="#0">https://pmc.ncbi.nlm.nih.gov/articles/PMC7394950/#sup1</a>):</p>
<p>DEFF_cv = 1+((m(1+CV^2)−1))ICC , whereby CV is the coefficient of variation (ratio of standard deviation of cluster sizes to mean of cluster sizes)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>p_C <span class="ot">&lt;-</span> <span class="fl">0.75</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>p_I1 <span class="ot">&lt;-</span> <span class="fl">0.50</span> </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>p_I2 <span class="ot">&lt;-</span> <span class="fl">0.45</span> </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>power <span class="ot">&lt;-</span> <span class="fl">0.80</span> </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>ICC <span class="ot">&lt;-</span> <span class="fl">0.20</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span> <span class="co"># do not apply any (bonferroni) correction for multiplicity (see separate discussion). Bonferroni would be alpha_familywise / number of comparisons (=2)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>CV <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># minimal CV</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>deff <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">+</span>(m<span class="dv">-1</span>)<span class="sc">*</span>ICC <span class="co"># standard DEFF</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>deff_cv <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">+</span>((m<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>CV<span class="sc">^</span><span class="dv">2</span>))<span class="sc">-</span><span class="dv">1</span>)<span class="sc">*</span>ICC <span class="co"># DEFF with cluster size variation</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Effect sizes</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>h_I1_C <span class="ot">&lt;-</span> <span class="fu">ES.h</span>(<span class="at">p1 =</span> p_I1, <span class="at">p2 =</span> p_C)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>h_I2_C <span class="ot">&lt;-</span> <span class="fu">ES.h</span>(<span class="at">p1 =</span> p_I2, <span class="at">p2 =</span> p_C)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Individual RCT sample sizes for both contrasts</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>ss1 <span class="ot">&lt;-</span> <span class="fu">pwr.2p.test</span>(<span class="at">h =</span> h_I1_C, <span class="at">power =</span> <span class="fl">0.80</span>, <span class="at">sig.level =</span> alpha)<span class="sc">$</span>n</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>ss2 <span class="ot">&lt;-</span> <span class="fu">pwr.2p.test</span>(<span class="at">h =</span> h_I2_C, <span class="at">power =</span> <span class="fl">0.80</span>, <span class="at">sig.level =</span> alpha)<span class="sc">$</span>n</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co"># CRT sample sizes for both contrasts</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>ss1_crt <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(ss1 <span class="sc">*</span> deff_cv)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>ss2_crt <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(ss2 <span class="sc">*</span> deff_cv)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Contrast 1 (smaller Delta/Cohens'd =&gt; determines overall cluster number)</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>n_clusters1 <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(ss1_crt <span class="sc">/</span> m)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cluster sample size int arm 1:"</span>, n_clusters1, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cluster sample size int arm 1: 13 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Individual sample size int arm 1:"</span>, ss1_crt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Individual sample size int arm 1: 509 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Contrast 2</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>n_clusters2 <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(ss2_crt <span class="sc">/</span> m)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cluster sample size int arm 2:"</span>, n_clusters2, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cluster sample size int arm 2: 9 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Individual sample size int arm 2:"</span>, ss2_crt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Individual sample size int arm 2: 359 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Total</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>tot_clusters <span class="ot">&lt;-</span> n_clusters1 <span class="sc">*</span> <span class="dv">3</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>tot_ind <span class="ot">&lt;-</span> ss1_crt <span class="sc">*</span> <span class="dv">3</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total cluster sample size:"</span>, tot_clusters, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total cluster sample size: 39 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total individual sample size:"</span>, tot_ind, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total individual sample size: 1527 </code></pre>
</div>
</div>
<section id="varying-assumptions---standard-sample-size-calculation" class="level2">
<h2 class="anchored" data-anchor-id="varying-assumptions---standard-sample-size-calculation"><strong>(1.1) Varying assumptions - Standard sample size calculation</strong></h2>
<section id="varying-baseline-control-rate" class="level3">
<h3 class="anchored" data-anchor-id="varying-baseline-control-rate"><strong>(1.1.1) Varying baseline control rate</strong></h3>
<p>All parameters fixed, except baseline control rate versus number of clusters &amp; individuals needed</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define fixed parameters</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>power <span class="ot">&lt;-</span> <span class="fl">0.80</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>ICC <span class="ot">&lt;-</span> <span class="fl">0.20</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>CV <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline control rates</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>p_C_values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.60</span>, <span class="fl">0.85</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_C =</span> <span class="fu">numeric</span>(),</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_clusters_per_arm =</span> <span class="fu">numeric</span>(),</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_individuals_per_arm =</span> <span class="fu">numeric</span>()</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>cohen_h <span class="ot">&lt;-</span> <span class="cf">function</span>(p1, p2) {</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span> <span class="sc">*</span> (<span class="fu">asin</span>(<span class="fu">sqrt</span>(p1)) <span class="sc">-</span> <span class="fu">asin</span>(<span class="fu">sqrt</span>(p2)))</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (p_C <span class="cf">in</span> p_C_values) {</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  p_I1 <span class="ot">&lt;-</span> p_C <span class="sc">-</span> <span class="fl">0.25</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  p_I2 <span class="ot">&lt;-</span> p_C <span class="sc">-</span> <span class="fl">0.30</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Skip if intervention rates are invalid (less than 0)</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_I1 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">|</span> p_I2 <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>  deff_cv <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> ((m <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> CV<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> ICC</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  h_I1_C <span class="ot">&lt;-</span> <span class="fu">cohen_h</span>(p_I1, p_C)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  h_I2_C <span class="ot">&lt;-</span> <span class="fu">cohen_h</span>(p_I2, p_C)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>  ss1 <span class="ot">&lt;-</span> <span class="fu">pwr.2p.test</span>(<span class="at">h =</span> h_I1_C, <span class="at">power =</span> power, <span class="at">sig.level =</span> alpha)<span class="sc">$</span>n</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>  ss2 <span class="ot">&lt;-</span> <span class="fu">pwr.2p.test</span>(<span class="at">h =</span> h_I2_C, <span class="at">power =</span> power, <span class="at">sig.level =</span> alpha)<span class="sc">$</span>n</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use max of the two</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>  n_per_arm_rct <span class="ot">&lt;-</span> <span class="fu">max</span>(ss1, ss2)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Individual sample size</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>  n_per_arm_crt <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(n_per_arm_rct <span class="sc">*</span> deff_cv)</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cluster sample size</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  n_clusters_per_arm <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(n_per_arm_crt <span class="sc">/</span> m)</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Append results</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>  results_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results_df, <span class="fu">data.frame</span>(</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_C =</span> p_C,</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_clusters_per_arm =</span> n_clusters_per_arm,</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_individuals_per_arm =</span> n_per_arm_crt</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> p_C, <span class="at">y =</span> n_clusters_per_arm <span class="sc">*</span> <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total clusters needed vs. Baseline control rate"</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Baseline control rate"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total clusters needed (for 3 arms)"</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.50</span>, <span class="fl">0.85</span>, <span class="at">by =</span> <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(results_df<span class="sc">$</span>n_clusters_per_arm <span class="sc">*</span> <span class="dv">3</span>), <span class="at">by =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> p_C, <span class="at">y =</span> n_individuals_per_arm <span class="sc">*</span> <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"lightgreen"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"lightgreen"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total individuals needed vs. Baseline control rate"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Baseline control rate"</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total individuals needed (for 3 arms)"</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.60</span>, <span class="fl">0.85</span>, <span class="at">by =</span> <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(results_df<span class="sc">$</span>n_individuals_per_arm <span class="sc">*</span> <span class="dv">3</span>), <span class="at">by =</span> <span class="dv">50</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="varying-icc" class="level3">
<h3 class="anchored" data-anchor-id="varying-icc"><strong>(1.1.2) Varying ICC</strong></h3>
<p>All parameters fixed, except ICC versus number of clusters &amp; individuals needed</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define parameters</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>power <span class="ot">&lt;-</span> <span class="fl">0.80</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>p_C <span class="ot">&lt;-</span> <span class="fl">0.75</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>CV <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Range of ICC values to test</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>ICC_values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ICC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_clusters_per_arm =</span> <span class="fu">numeric</span>(),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_individuals_per_arm =</span> <span class="fu">numeric</span>()</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>cohen_h <span class="ot">&lt;-</span> <span class="cf">function</span>(p1, p2) {</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span> <span class="sc">*</span> (<span class="fu">asin</span>(<span class="fu">sqrt</span>(p1)) <span class="sc">-</span> <span class="fu">asin</span>(<span class="fu">sqrt</span>(p2)))</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (icc <span class="cf">in</span> ICC_values) {</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  p_I1 <span class="ot">&lt;-</span> p_C <span class="sc">-</span> <span class="fl">0.25</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  p_I2 <span class="ot">&lt;-</span> p_C <span class="sc">-</span> <span class="fl">0.30</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  deff_cv <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> ((m <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> CV<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> icc</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  h_I1_C <span class="ot">&lt;-</span> <span class="fu">cohen_h</span>(p_I1, p_C)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  h_I2_C <span class="ot">&lt;-</span> <span class="fu">cohen_h</span>(p_I2, p_C)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  ss1 <span class="ot">&lt;-</span> <span class="fu">pwr.2p.test</span>(<span class="at">h =</span> h_I1_C, <span class="at">power =</span> power, <span class="at">sig.level =</span> alpha)<span class="sc">$</span>n</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  ss2 <span class="ot">&lt;-</span> <span class="fu">pwr.2p.test</span>(<span class="at">h =</span> h_I2_C, <span class="at">power =</span> power, <span class="at">sig.level =</span> alpha)<span class="sc">$</span>n</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  n_per_arm_rct <span class="ot">&lt;-</span> <span class="fu">max</span>(ss1, ss2)</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>  n_per_arm_crt <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(n_per_arm_rct <span class="sc">*</span> deff_cv)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>  n_clusters_per_arm <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(n_per_arm_crt <span class="sc">/</span> m)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>  results_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results_df, <span class="fu">data.frame</span>(</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">ICC =</span> icc,</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_clusters_per_arm =</span> n_clusters_per_arm,</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_individuals_per_arm =</span> n_per_arm_crt</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> ICC, <span class="at">y =</span> n_clusters_per_arm <span class="sc">*</span> <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total clusters needed vs. ICC"</span>,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"ICC"</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total clusters needed (for 3 arms)"</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="at">by =</span> <span class="fl">0.01</span>)) <span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(results_df<span class="sc">$</span>n_clusters_per_arm <span class="sc">*</span> <span class="dv">3</span>), <span class="at">by =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> ICC, <span class="at">y =</span> n_individuals_per_arm <span class="sc">*</span> <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total individuals needed vs. ICC"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"ICC"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total individuals needed (for 3 arms)"</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="at">by =</span> <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(results_df<span class="sc">$</span>n_individuals_per_arm <span class="sc">*</span> <span class="dv">3</span>), <span class="at">by =</span> <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="sample-size-calculation-crt-simulations" class="level1">
<h1><strong>(2) Sample size calculation CRT: Simulations</strong></h1>
<section id="parameters" class="level2">
<h2 class="anchored" data-anchor-id="parameters"><strong>(2.1) Parameters</strong></h2>
<p>We follow the simulation setup according to J. Thompson &amp; C. Leyrat, because we have a binary outcome and small-ish cluster sample size (26-30 clusters for the main pair-wise comparison): <a href="https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-022-01699-2" class="uri">https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-022-01699-2</a></p>
<p>Note: We simulate a two-arm trial setup (not three-arm), since power/sample size is based on the main pair-wise comparison (control vs int 1) =&gt; Max. 26 clusters!</p>
<p><strong>Data-generating model (per cluster):</strong></p>
<ul>
<li><p>For arm i (0=control, 1=intervention) and cluster j: Y_ij ∼ Binomial(m_ij, p_ij), logit⁡(p_ij) = β0 + β1_i + u_j , where u_j is a cluster random effect with mean 0 and variance σ^2_b</p>
<ul>
<li><p>​Binomial(m_ij, p_ij): Conditional on p_ij, we assume each of the m_ij individuals in that cluster are independent Bernoulli trials with probability p_ij. So Y_ij is a binomial draw with that probability, for the cluster-level.</p>
<ul>
<li><p>A Bernoulli trial is a random event with two outcomes (success/failure), with the same, independent, probability of success every time.</p></li>
<li><p>Independence assumption (within-cluster): Whether one person gets the prescription doesn’t change the probability for another person in the same cluster (once p_ij is fixed). The correlation between people’s outcomes in the same cluster comes entirely from them sharing the same p_ij.</p></li>
<li><p>=&gt; Y_ij can be any integer from 0 to m_ij. E.g. if m_ij =42 and p_ij =0.50, then Y_ij is the total number of prescriptions in that cluster, drawn from a binomial distribution with 42 trials and 50% success probability.</p></li>
</ul></li>
<li><p>logit⁡(p_ij) = β0 + β1_i + u_j:</p>
<ul>
<li><p>Using the logit link maps probability p ∈ (0,1) to the whole real line, so we can model it as a linear predictor.</p></li>
<li><p>β0 is the baseline log-odds (the logit of the control probability for a <em>typical</em> cluster, i.e.&nbsp;when u_j = 0), representing the the marginal cluster-specific probability.</p></li>
<li><p>β1_i encodes the treatment effect and is a log-odds difference; exp⁡(β1) is the <em>conditional odds ratio</em> comparing treatment vs control for the <em>same cluster</em> (holding u_j fixed).</p></li>
<li><p>u_j is the cluster random intercept (a cluster-level shift on the log-odds scale). It captures unobserved cluster-level factors (e.g.&nbsp;prescriber tendency) that move all individuals in the cluster up/down in log-odds. Typically, u_j has mean 0 and variance σ^2_b and is independent across clusters (see above). The random intercept does not change the conditional treatment effect, it only shifts the baseline log-odds for that whole cluster. In other words, the <em>difference in log-odds</em> between arms for the same cluster is always constant, but the <em>actual probabilities</em> shift up/down with u_j. For clusters with positive u_j both arms have higher probabilities; for negative u_j both are lower.</p></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ICC on log-odds scale:</strong></p>
<ul>
<li><p>ICC = <em>p = rho</em> = σ^2_b / (σ^2_b+(π^2/3))</p></li>
<li><p>The ICC consists of individual-level variance (noise) and between-cluster variance (noise), in the sense of: between-cluster variance / total variance. The between-cluster variance approximates the cluster random effect variance (σ^2_b)</p></li>
<li><p>In logistic models, the individual level variation is usually fixed at π^2/3 (3.29)</p></li>
<li><p>So, focusing on the cluster random effect variance (σ^2_b), we can derive it from the formula above as: σ_b = <em>sigma_b</em> = sqrt((ICC(π^2/3))/(1−ICC))</p></li>
<li><p>(If there’s additional within-site variation over time, i.e.&nbsp;baseline period or SW-CRT, we include σ^2_b_p, typically as a fraction of σ^2_b, e.g., half the site-level variance).</p></li>
</ul>
<p><strong>Cluster effect distributions:</strong></p>
<ul>
<li><p>While ICC is the proportion of the total variance (in the latent scale) that comes from between-cluster differences (“what fraction of the total variability is due to between-cluster differences”), the σ^2_b is an absolute variance (“How big the cluster intercept spread is in log-odds units” or “how much variation there is in prescription tendency across clusters”) and can have different shapes.</p></li>
<li><p>GLMM assumes normal distribution, but reality is often skewed - esp.&nbsp;with few clusters! Simulate three scenarios including a realistic/skewed/conservative scenario and see if GLMM breaks (as in paper above):</p></li>
<li><p>a) Normal: u_j ∼ N(0, σ^2_b)</p>
<ul>
<li>Symmetric, bell-shaped, skewness = 0, kurtosis = 0.</li>
</ul></li>
<li><p>b) Gamma (skewed): generate a_j ∼ Gamma(shape=2,scale=1), then set u_j ​= σ_b(​(a_j​−2)/sqrt(2))</p>
<ul>
<li>A shape parameter of 2 give a distribution with skew 1.4 and kurtosis 3, i.e., positive skew (some clusters much higher tendency than average)</li>
</ul></li>
<li><p>c) Uniform: u_j ∼ Uniform(−sqrt(3)σ_b, sqrt(3)σ_b)</p>
<ul>
<li>Skewness = 0 (perfectly symmetric), Kurtosis = −6/5 (lighter tails than normal), no extreme values, overall flat, all clusters are evenly spread; to test if GLMMs are sensitive to lack of tail weight, i.e., whether they rely on the normal distribution’s tails to stabilize estimates.</li>
</ul></li>
</ul>
<p><strong>Cluster sizes</strong> m_ij​:</p>
<ul>
<li><p>Allow for varying cluster size, i.e.&nbsp;varying coefficient of variation (CV) of cluster sizes, using same approach as they did: They sampled cluster sizes so that m_ij = 2 + δ_ij,​ drawn from a Negative Binomial:</p>
<ul>
<li><p>δ_ij ​∼ NegBin(size = (m-2)^2/(s^2-(m-2)), p = m-2/s^2)</p></li>
<li><p>where s is the SD of cluster sizes (CV = s/m).</p></li>
<li><p>This yields a minimum cluster size of 3. (note: they wrote no.offails and prob.offail; but the above should represent the same).</p></li>
<li><p>δ is in a way the random component added to 2 to get the cluster size (of min 3).</p></li>
</ul></li>
</ul>
</section>
<section id="create-main-functions-and-simulate-one-dataset" class="level2">
<h2 class="anchored" data-anchor-id="create-main-functions-and-simulate-one-dataset"><strong>(2.2) Create main functions and simulate one dataset</strong></h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) compute sigma_b from ICC (on latent logit scale):</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>icc_to_sigma <span class="ot">&lt;-</span> <span class="cf">function</span>(rho){</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(rho<span class="sc">&lt;=</span><span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="ot">&lt;-</span> <span class="fu">sqrt</span>( (rho <span class="sc">*</span> (pi<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>)) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> rho) )</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sigma_b)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) compute beta0 for given control prevalence p0</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>p_to_beta0 <span class="ot">&lt;-</span> <span class="cf">function</span>(p0){</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">qlogis</span>(p0)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) given p0 and p1, compute OR on the cluster-specific log-odds scale</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>p0_p1_to_OR <span class="ot">&lt;-</span> <span class="cf">function</span>(p0, p1){</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  odds0 <span class="ot">&lt;-</span> p0 <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p0)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  odds1 <span class="ot">&lt;-</span> p1 <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p1)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  odds1 <span class="sc">/</span> odds0</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) generate random cluster-level u_j for the three distributions</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>generate_u <span class="ot">&lt;-</span> <span class="cf">function</span>(n_clusters, sigma_b, <span class="at">dist =</span> <span class="fu">c</span>(<span class="st">"normal"</span>,<span class="st">"gamma"</span>,<span class="st">"uniform"</span>)){</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  dist <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(dist)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(sigma_b <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">rep</span>(<span class="dv">0</span>, n_clusters))</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(dist <span class="sc">==</span> <span class="st">"normal"</span>){</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">rnorm</span>(n_clusters, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd =</span> sigma_b))</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(dist <span class="sc">==</span> <span class="st">"gamma"</span>){</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># they used Gamma(shape=2, scale=1) then standardized to mean 0 and sd sigma_b</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(n_clusters, <span class="at">shape=</span><span class="dv">2</span>, <span class="at">scale=</span><span class="dv">1</span>)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a has mean 2, var 2. Standardize: (a - 2)/sqrt(2) then scale to sigma_b</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(sigma_b <span class="sc">*</span> (a <span class="sc">-</span> <span class="dv">2</span>)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>))</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(dist <span class="sc">==</span> <span class="st">"uniform"</span>){</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    cut <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">3</span>) <span class="sc">*</span> sigma_b</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">runif</span>(n_clusters, <span class="at">min =</span> <span class="sc">-</span>cut, <span class="at">max =</span> cut))</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) generate cluster sizes with target mean m and CV. Implementation follows their negative-binomial based approach and enforces minimum cluster size of 3.</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>generate_cluster_sizes <span class="ot">&lt;-</span> <span class="cf">function</span>(n_clusters, m, CV){</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(CV <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">rep</span>(m, n_clusters))</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> CV <span class="sc">*</span> m</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We want delta = m_j - 2 to follow NegBin with mean (m-2) and variance s^2</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>  mu_delta <span class="ot">&lt;-</span> m <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>  var_delta <span class="ot">&lt;-</span> s<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(var_delta <span class="sc">&lt;=</span> mu_delta){</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Negative Binomial requires variance &gt; mean. So, this is an impossible NB parameterization</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If so, fall back to a discrete uniform around m</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    low <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">3</span>, <span class="fu">floor</span>(m <span class="sc">-</span> s<span class="sc">*</span><span class="fl">1.5</span>))</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    high <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(m <span class="sc">+</span> s<span class="sc">*</span><span class="fl">1.5</span>)</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">3</span>, <span class="fu">round</span>(<span class="fu">runif</span>(n_clusters, low, high)))</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(out)</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>  size_nb <span class="ot">&lt;-</span> (mu_delta<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (var_delta <span class="sc">-</span> mu_delta) <span class="co"># see formula above</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>  prob_nb <span class="ot">&lt;-</span> mu_delta <span class="sc">/</span> var_delta <span class="co"># see formula above</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rnbinom in R uses size, prob; mean = size*(1-prob)/prob, but with this param it matches</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="fu">rnbinom</span>(n_clusters, <span class="at">size =</span> size_nb, <span class="at">prob =</span> prob_nb)</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>  m_j <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> delta</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>  m_j[m_j <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># enforce min 3 (generating 2+delta ensures &gt;=2, we bump to 3)</span></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(m_j)</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for single simulated dataset</span></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>n_clusters <span class="ot">&lt;-</span> <span class="dv">26</span></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>m_mean <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>CV <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>p0 <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fl">0.50</span></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>OR <span class="ot">&lt;-</span> <span class="fu">p0_p1_to_OR</span>(p0, p1) <span class="co"># compute OR from p0 and p1</span></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fl">0.20</span> <span class="co"># ICC</span></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>re_dist <span class="ot">&lt;-</span> <span class="st">"uniform"</span></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20250809</span>)</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>sigma_b <span class="ot">&lt;-</span> <span class="fu">icc_to_sigma</span>(rho)</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>u_j <span class="ot">&lt;-</span> <span class="fu">generate_u</span>(n_clusters, sigma_b, <span class="at">dist =</span> re_dist)</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>sizes <span class="ot">&lt;-</span> <span class="fu">generate_cluster_sizes</span>(n_clusters, m_mean, CV)</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>arm_assign <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">length.out =</span> n_clusters))</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> <span class="fu">p_to_beta0</span>(p0)</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>beta1 <span class="ot">&lt;-</span> <span class="fu">log</span>(OR)</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">integer</span>(n_clusters)</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="fu">seq_len</span>(n_clusters)){ <span class="co"># iterate over each cluster</span></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the linear predictor (</span><span class="al">NOTE</span><span class="co">: beta1 turns 0 if arm0, and 1 * beta1 if arm1)</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>  linpred <span class="ot">&lt;-</span> beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> arm_assign[j] <span class="sc">+</span> u_j[j] </span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply the inverse logit (logistic function) to convert log-odds to probability</span></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>  p_j <span class="ot">&lt;-</span> <span class="fu">plogis</span>(linpred) </span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate the number of successes in cluster j</span></span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>  y[j] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="at">size =</span> sizes[j], <span class="at">prob =</span> p_j) </span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">cluster =</span> <span class="fu">seq_len</span>(n_clusters),</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>                      <span class="at">arm =</span> arm_assign,</span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>                      <span class="at">size =</span> sizes,</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y =</span> y)</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>df_sim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   cluster arm size  y
1        1   1   39 15
2        2   0   35 32
3        3   1   37 19
4        4   0   41 33
5        5   0   39 29
6        6   0   41 37
7        7   0   38 29
8        8   0   45 31
9        9   0   43 28
10      10   1   43 27
11      11   1   44 33
12      12   1   45 20
13      13   0   39 25
14      14   1   39 32
15      15   1   41 29
16      16   1   41 35
17      17   0   40 31
18      18   1   36 33
19      19   0   36 25
20      20   1   38 12
21      21   0   37 30
22      22   1   41 21
23      23   1   41  7
24      24   0   43 35
25      25   1   44 39
26      26   0   39 20</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>mean_sizes <span class="ot">&lt;-</span> df_sim <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(arm) <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_size =</span> <span class="fu">mean</span>(size))</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_sim, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(cluster), <span class="at">y =</span> size, <span class="at">fill =</span> <span class="fu">factor</span>(arm))) <span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">data =</span> mean_sizes, <span class="fu">aes</span>(<span class="at">yintercept =</span> mean_size, <span class="at">color =</span> <span class="fu">factor</span>(arm)),</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> mean_sizes, <span class="fu">aes</span>(<span class="at">x =</span> <span class="cn">Inf</span>, <span class="at">y =</span> mean_size, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean = "</span>, <span class="fu">round</span>(mean_size, <span class="dv">1</span>))),</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="fl">1.1</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">color =</span> <span class="fu">c</span>(<span class="st">"skyblue4"</span>, <span class="st">"tomato3"</span>), <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"skyblue"</span>, <span class="st">"tomato"</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Control (arm=0)"</span>, <span class="st">"Intervention (arm=1)"</span>)) <span class="sc">+</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"skyblue4"</span>, <span class="st">"tomato3"</span>)) <span class="sc">+</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Cluster"</span>, <span class="at">y =</span> <span class="st">"Cluster Size"</span>, <span class="at">fill =</span> <span class="st">"Treatment Group"</span>) <span class="sc">+</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Cluster size per cluster"</span>) <span class="sc">+</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>size = number of individuals in a cluster</p>
<p>y = number of individual-level successes (binary=1) observed in the cluster, i.e., represents the number of individuals in that cluster who received an AB prescription.</p>
</section>
<section id="simulate-power-using-cluster-level-analysis-approach" class="level2">
<h2 class="anchored" data-anchor-id="simulate-power-using-cluster-level-analysis-approach"><strong>(2.3) Simulate power, using cluster-level analysis approach</strong></h2>
<p>NOTES:</p>
<ul>
<li><p>Use cluster-level analysis (unweighted t-test on log-odds, with 0.5 continuity correction, as per guidance according to Thompson &amp; Leyrat &amp; al -&gt; “clan” command)</p></li>
<li><p>Keep gamma distribution, simulate 500-1000 trials</p></li>
</ul>
<section id="create-function" class="level3">
<h3 class="anchored" data-anchor-id="create-function"><strong>(2.3.1) Create function</strong></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>simulate_power <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_clusters =</span> <span class="dv">26</span>, </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">m_mean =</span> <span class="dv">40</span>, </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">p0 =</span> <span class="fl">0.75</span>, </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">p1 =</span> <span class="fl">0.50</span>, </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">rho =</span> <span class="fl">0.20</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">re_dist =</span> <span class="st">"gamma"</span>, </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n_sim =</span> <span class="dv">1000</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">alpha =</span> <span class="fl">0.05</span>, </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">seed =</span> <span class="dv">20250809</span>) {</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute derived parameters</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="ot">&lt;-</span> <span class="fu">icc_to_sigma</span>(rho)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="ot">&lt;-</span> <span class="fu">p_to_beta0</span>(p0)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  OR <span class="ot">&lt;-</span> <span class="fu">p0_p1_to_OR</span>(p0, p1)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  beta1 <span class="ot">&lt;-</span> <span class="fu">log</span>(OR)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  p_values <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_sim)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(n_sim)) {</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    u_j <span class="ot">&lt;-</span> <span class="fu">generate_u</span>(n_clusters, sigma_b, <span class="at">dist =</span> re_dist)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    sizes <span class="ot">&lt;-</span> <span class="fu">generate_cluster_sizes</span>(n_clusters, m_mean, CV)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    arm_assign <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">length.out =</span> n_clusters))</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">integer</span>(n_clusters)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(n_clusters)) {</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>      linpred <span class="ot">&lt;-</span> beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> arm_assign[j] <span class="sc">+</span> u_j[j]</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>      p_j <span class="ot">&lt;-</span> <span class="fu">plogis</span>(linpred)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>      y[j] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="at">size =</span> sizes[j], <span class="at">prob =</span> p_j)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cluster-level log-odds with 0.5 continuity correction</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    log_odds <span class="ot">&lt;-</span> <span class="fu">log</span>((y <span class="sc">+</span> <span class="fl">0.5</span>) <span class="sc">/</span> (sizes <span class="sc">-</span> y <span class="sc">+</span> <span class="fl">0.5</span>))</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unweighted t-test</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    group0 <span class="ot">&lt;-</span> log_odds[arm_assign <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    group1 <span class="ot">&lt;-</span> log_odds[arm_assign <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    test <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">t.test</span>(group1, group0, <span class="at">var.equal =</span> <span class="cn">TRUE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    p_values[i] <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">inherits</span>(test, <span class="st">"try-error"</span>)) <span class="cn">NA</span> <span class="cf">else</span> test<span class="sc">$</span>p.value</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate power</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(p_values <span class="sc">&lt;</span> alpha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="calculate-baseline-scenario" class="level3">
<h3 class="anchored" data-anchor-id="calculate-baseline-scenario"><strong>(2.3.2)</strong> Calculate baseline scenario</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>power_estimate <span class="ot">&lt;-</span> <span class="fu">simulate_power</span>(<span class="at">n_clusters =</span> <span class="dv">26</span>,</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">m_mean =</span> <span class="dv">40</span>,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p0 =</span> <span class="fl">0.75</span>,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1 =</span> <span class="fl">0.50</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">rho =</span> <span class="fl">0.20</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">n_sim =</span> <span class="dv">1000</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated power:"</span>, <span class="fu">round</span>(power_estimate, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated power: 0.79 </code></pre>
</div>
</div>
</section>
<section id="vary-effect-sizes" class="level3">
<h3 class="anchored" data-anchor-id="vary-effect-sizes"><strong>(2.3.3) Vary effect sizes</strong></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>p0_vals <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.50</span>, <span class="fl">0.85</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>p1_vals <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.30</span>, <span class="fl">0.70</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">p0 =</span> p0_vals, <span class="at">p1 =</span> p1_vals)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> grid <span class="sc">%&gt;%</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">power =</span> <span class="fu">simulate_power</span>(<span class="at">n_clusters =</span> <span class="dv">26</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>                                <span class="at">m_mean =</span> <span class="dv">40</span>,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>                                <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>                                <span class="at">p0 =</span> p0,</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>                                <span class="at">p1 =</span> p1,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>                                <span class="at">rho =</span> <span class="fl">0.2</span>,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>                                <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n_sim =</span> <span class="dv">1000</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> p1, <span class="at">y =</span> power, <span class="at">color =</span> <span class="fu">factor</span>(p0))) <span class="sc">+</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Shaded region above 80% power</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">xmax =</span> <span class="cn">Inf</span>, <span class="at">ymin =</span> <span class="fl">0.8</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>),</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"lightgrey"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Power curves</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Labels and scales</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power Curves by p0 and p1 (two-arm/pair-wise comparison)"</span>,</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Intervention Group Probability (p1)"</span>,</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Estimated Power"</span>,</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Control Group (p0)"</span>) <span class="sc">+</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="vary-icc" class="level3">
<h3 class="anchored" data-anchor-id="vary-icc"><strong>(2.3.4) Vary ICC</strong></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vector of ICC values to test</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>icc_values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="at">by =</span> <span class="fl">0.02</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run power simulations for each ICC</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>power_results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(icc_values, <span class="cf">function</span>(rho) {</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate_power</span>(<span class="at">n_clusters =</span> <span class="dv">26</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">m_mean =</span> <span class="dv">40</span>,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p0 =</span> <span class="fl">0.75</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p1 =</span> <span class="fl">0.50</span>,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rho =</span> rho,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n_sim =</span> <span class="dv">1000</span>,</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">alpha =</span> <span class="fl">0.05</span>,</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">20250809</span>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame for plotting</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>df_power_icc <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ICC =</span> icc_values, <span class="at">Power =</span> power_results)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_power_icc, <span class="fu">aes</span>(<span class="at">x =</span> ICC, <span class="at">y =</span> Power)) <span class="sc">+</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power Curve by ICC (two-arm/pair-wise comparison)"</span>,</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Intraclass Correlation (ICC)"</span>,</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Estimated Power"</span>) <span class="sc">+</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.70</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.70</span>, <span class="dv">1</span>),</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="vary-number-of-clusters" class="level3">
<h3 class="anchored" data-anchor-id="vary-number-of-clusters"><strong>(2.3.5) Vary number of clusters</strong></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vector of cluster counts to test</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>n_clusters_vec <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">22</span>, <span class="dv">36</span>, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run power simulations for each cluster count</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>power_results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(n_clusters_vec, <span class="cf">function</span>(nc) {</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate_power</span>(<span class="at">n_clusters =</span> nc,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">m_mean =</span> <span class="dv">40</span>,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p0 =</span> <span class="fl">0.75</span>,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p1 =</span> <span class="fl">0.50</span>,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rho =</span> <span class="fl">0.20</span>,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n_sim =</span> <span class="dv">5000</span>,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">alpha =</span> <span class="fl">0.05</span>,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">20250809</span>)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame for plotting</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>df_power_css <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Cluster_ss =</span> n_clusters_vec, <span class="at">Power =</span> power_results)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_power_css, <span class="fu">aes</span>(<span class="at">x =</span> Cluster_ss, <span class="at">y =</span> Power)) <span class="sc">+</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"forestgreen"</span>) <span class="sc">+</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power vs Number of total clusters (two-arm/pair-wise comparison)"</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Total number of clusters (two-arm trial)"</span>,</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Estimated power"</span>) <span class="sc">+</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.70</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.70</span>, <span class="dv">1</span>),</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">22</span>, <span class="dv">36</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="vary-number-of-individuals-per-cluster-mean-cluster-size" class="level3">
<h3 class="anchored" data-anchor-id="vary-number-of-individuals-per-cluster-mean-cluster-size"><strong>(2.3.6) Vary number of individuals per cluster (mean cluster size)</strong></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>m_mean_vec <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">180</span>, <span class="at">by =</span> <span class="dv">10</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Run power simulations for each cluster count</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>power_results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(m_mean_vec, <span class="cf">function</span>(n) {</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate_power</span>(<span class="at">n_clusters =</span> <span class="dv">26</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">m_mean =</span> n,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p0 =</span> <span class="fl">0.75</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p1 =</span> <span class="fl">0.50</span>,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rho =</span> <span class="fl">0.20</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n_sim =</span> <span class="dv">1000</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">alpha =</span> <span class="fl">0.05</span>,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">20250809</span>)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame for plotting</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>df_power_iss <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Individual_ss =</span> m_mean_vec, <span class="at">Power =</span> power_results)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_power_iss, <span class="fu">aes</span>(<span class="at">x =</span> Individual_ss, <span class="at">y =</span> Power)) <span class="sc">+</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"skyblue"</span>) <span class="sc">+</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power vs Number of total individuals (two-arm/pair-wise comparison)"</span>,</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Total number of individuals (two-arm trial)"</span>,</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Estimated power"</span>) <span class="sc">+</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.70</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.70</span>, <span class="dv">1</span>),</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">180</span>, <span class="at">by =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="simulate-power-using-glmm-analysis-approach" class="level2">
<h2 class="anchored" data-anchor-id="simulate-power-using-glmm-analysis-approach"><strong>(2.4) Simulate power, using GLMM analysis approach</strong></h2>
<p><strong>NOTES:</strong></p>
<ul>
<li><p>As per guidance according to Thompson &amp; Leyrat &amp; al: GLMM with restricted pseudo-likelihood and reduced degree of freedom (minus all covariates in the model)</p></li>
<li><p>Keep gamma distribution throughout</p></li>
</ul>
<section id="create-function-1" class="level3">
<h3 class="anchored" data-anchor-id="create-function-1"><strong>(2.4.1) Create function</strong></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>simulate_power_glmmPQL <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_clusters =</span> <span class="dv">26</span>, </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">m_mean =</span> <span class="dv">40</span>, </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">p0 =</span> <span class="fl">0.75</span>, </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">p1 =</span> <span class="fl">0.50</span>, </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">rho =</span> <span class="fl">0.20</span>,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">re_dist =</span> <span class="st">"gamma"</span>, </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">n_sim =</span> <span class="dv">1000</span>,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">alpha =</span> <span class="fl">0.05</span>, </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> <span class="dv">20250809</span>) {</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="ot">&lt;-</span> <span class="fu">icc_to_sigma</span>(rho)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="ot">&lt;-</span> <span class="fu">p_to_beta0</span>(p0)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  OR <span class="ot">&lt;-</span> <span class="fu">p0_p1_to_OR</span>(p0, p1)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  beta1 <span class="ot">&lt;-</span> <span class="fu">log</span>(OR)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  p_values <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_sim)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(n_sim)) {</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    u_j <span class="ot">&lt;-</span> <span class="fu">generate_u</span>(n_clusters, sigma_b, <span class="at">dist =</span> re_dist)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    sizes <span class="ot">&lt;-</span> <span class="fu">generate_cluster_sizes</span>(n_clusters, m_mean, CV)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    arm_assign <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">length.out =</span> n_clusters))</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">integer</span>(n_clusters)</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>    arm <span class="ot">&lt;-</span> <span class="fu">integer</span>(n_clusters)</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    cluster <span class="ot">&lt;-</span> <span class="fu">integer</span>(n_clusters)</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(n_clusters)) {</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>      linpred <span class="ot">&lt;-</span> beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> arm_assign[j] <span class="sc">+</span> u_j[j]</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>      p_j <span class="ot">&lt;-</span> <span class="fu">plogis</span>(linpred)</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>      y[j] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="at">size =</span> sizes[j], <span class="at">prob =</span> p_j)</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>      arm[j] <span class="ot">&lt;-</span> arm_assign[j]</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>      cluster[j] <span class="ot">&lt;-</span> j</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>    dd_sim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> y,</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> sizes,</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">arm =</span> <span class="fu">factor</span>(arm),</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">cluster =</span> <span class="fu">factor</span>(cluster)</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit GLMM using glmmPQL</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>    model_pql <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">glmmPQL</span>(</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed =</span> <span class="fu">cbind</span>(y, size <span class="sc">-</span> y) <span class="sc">~</span> arm,</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">random =</span> <span class="sc">~</span><span class="dv">1</span> <span class="sc">|</span> cluster,</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dd_sim,</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(model_pql, <span class="st">"try-error"</span>)) {</span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>      df_manual <span class="ot">&lt;-</span> n_clusters <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">fixef</span>(model_pql))</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>      coef <span class="ot">&lt;-</span> model_pql<span class="sc">$</span>coefficients<span class="sc">$</span>fixed[<span class="st">"arm1"</span>]</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>      se <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_pql)<span class="sc">$</span>tTable[<span class="st">"arm1"</span>, <span class="st">"Std.Error"</span>]</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>      t_stat <span class="ot">&lt;-</span> coef <span class="sc">/</span> se</span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>      p_values[i] <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pt</span>(<span class="sc">-</span><span class="fu">abs</span>(t_stat), <span class="at">df =</span> df_manual)</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>      p_values[i] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(p_values <span class="sc">&lt;</span> alpha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="calculate-baseline-scenario-1" class="level3">
<h3 class="anchored" data-anchor-id="calculate-baseline-scenario-1"><strong>(2.4.2)</strong> Calculate baseline scenario</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>power_estimate <span class="ot">&lt;-</span> <span class="fu">simulate_power_glmmPQL</span>(<span class="at">n_clusters =</span> <span class="dv">26</span>,</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">m_mean =</span> <span class="dv">40</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">p0 =</span> <span class="fl">0.75</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">p1 =</span> <span class="fl">0.50</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">rho =</span> <span class="fl">0.20</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">n_sim =</span> <span class="dv">1000</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated power (GLMM):"</span>, <span class="fu">round</span>(power_estimate, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated power (GLMM): 0.829 </code></pre>
</div>
</div>
</section>
<section id="vary-effect-sizes-1" class="level3">
<h3 class="anchored" data-anchor-id="vary-effect-sizes-1"><strong>(2.4.3) Vary effect sizes</strong></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>p0_vals <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.50</span>, <span class="fl">0.85</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>p1_vals <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.30</span>, <span class="fl">0.70</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>grid_glmm <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">p0 =</span> p0_vals, <span class="at">p1 =</span> p1_vals)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Use map2 to apply the function to each p0/p1 pair, more efficient</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>grid_glmm<span class="sc">$</span>power <span class="ot">&lt;-</span> <span class="fu">map2_dbl</span>(grid_glmm<span class="sc">$</span>p0, grid_glmm<span class="sc">$</span>p1, <span class="sc">~</span> <span class="fu">simulate_power_glmmPQL</span>(</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_clusters =</span> <span class="dv">26</span>,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">m_mean =</span> <span class="dv">40</span>,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">p0 =</span> .x,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1 =</span> .y,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.2</span>,</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_sim =</span> <span class="dv">300</span> <span class="co"># reduced for speed</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(grid_glmm, <span class="fu">aes</span>(<span class="at">x =</span> p1, <span class="at">y =</span> power, <span class="at">color =</span> <span class="fu">factor</span>(p0))) <span class="sc">+</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">xmax =</span> <span class="cn">Inf</span>, <span class="at">ymin =</span> <span class="fl">0.8</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>),</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"lightgrey"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power Curves by p0 and p1 (two-arm/pair-wise comparison, GLMM)"</span>,</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Intervention Group Probability (p1)"</span>,</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Estimated Power"</span>,</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Control Group (p0)"</span>) <span class="sc">+</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="vary-icc-1" class="level3">
<h3 class="anchored" data-anchor-id="vary-icc-1"><strong>(2.4.4) Vary ICC</strong></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>icc_values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="at">by =</span> <span class="fl">0.02</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>power_results_glmm <span class="ot">&lt;-</span> <span class="fu">sapply</span>(icc_values, <span class="cf">function</span>(rho) {</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate_power_glmmPQL</span>(<span class="at">n_clusters =</span> <span class="dv">26</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">m_mean =</span> <span class="dv">40</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p0 =</span> <span class="fl">0.75</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p1 =</span> <span class="fl">0.50</span>,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rho =</span> rho,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n_sim =</span> <span class="dv">300</span>, <span class="co"># reduced for speed</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">alpha =</span> <span class="fl">0.05</span>,</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">20250809</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>df_power_icc_glmm <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ICC =</span> icc_values, <span class="at">Power =</span> power_results_glmm)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_power_icc_glmm, <span class="fu">aes</span>(<span class="at">x =</span> ICC, <span class="at">y =</span> Power)) <span class="sc">+</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power Curve by ICC (two-arm/pair-wise comparison, GLMM)"</span>,</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Intraclass Correlation (ICC)"</span>,</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Estimated Power"</span>) <span class="sc">+</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.70</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.70</span>, <span class="dv">1</span>),</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="vary-number-of-clusters-1" class="level3">
<h3 class="anchored" data-anchor-id="vary-number-of-clusters-1"><strong>(2.4.5) Vary number of clusters</strong></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>n_clusters_vec <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">22</span>, <span class="dv">36</span>, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>power_results_glmm <span class="ot">&lt;-</span> <span class="fu">sapply</span>(n_clusters_vec, <span class="cf">function</span>(nc) {</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate_power_glmmPQL</span>(<span class="at">n_clusters =</span> nc,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">m_mean =</span> <span class="dv">40</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p0 =</span> <span class="fl">0.75</span>,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p1 =</span> <span class="fl">0.50</span>,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rho =</span> <span class="fl">0.20</span>,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n_sim =</span> <span class="dv">300</span>, <span class="co"># reduced for speed</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">alpha =</span> <span class="fl">0.05</span>,</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">20250809</span>)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>df_power_css_glmm <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Cluster_ss =</span> n_clusters_vec, <span class="at">Power =</span> power_results_glmm)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_power_css_glmm, <span class="fu">aes</span>(<span class="at">x =</span> Cluster_ss, <span class="at">y =</span> Power)) <span class="sc">+</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"forestgreen"</span>) <span class="sc">+</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power vs Number of total clusters (two-arm/pair-wise comparison, GLMM)"</span>,</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Total number of clusters (two-arm trial)"</span>,</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Estimated power"</span>) <span class="sc">+</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.70</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.70</span>, <span class="dv">1</span>),</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">22</span>, <span class="dv">36</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="simulate-the-full-dataset-and-implement-the-main-analysis-strategy" class="level1">
<h1><strong>(3) Simulate the full dataset and implement the main analysis strategy</strong></h1>
<p><strong>The main analysis strategy as per SAP:</strong></p>
<ul>
<li><p>Due to the relatively low number of clusters in each pair-wise comparison (n=&lt;30), we use a generalized linear mixed model (GLMM) with restricted pseudo-likelihood estimation and small-sample correction for degrees of freedom (clusters minus cluster-level parameters), as suggested by Thompson and colleagues(ref)</p></li>
<li><p>We will adjust the model for these <em>a priori</em> defined covariates (as fixed effects):</p>
<ul>
<li><p>Cluster-level covariates (cluster mean): attendance rate and baseline antibiotic prescription rate (as continuous covariates assuming linearity)</p></li>
<li><p>Individual-level covariates: Self-reported sex (as binary covariate: male, female) and age (as continuous covariates assuming non-linear association modelled using restricted cubic splines with 3 knots at 10<sup>th</sup>, 50<sup>th</sup> and 90<sup>th</sup> percentiles of the observed age distribution</p></li>
</ul></li>
<li><p>We will report the resulting treatment-effect (beta-1), which is the log-odds difference between intervention and control or – when exponentiated – the adjusted odds ratio, with its 95% confidence interval. This represents a relative cluster-specific effect, conditional on all included covariates. In addition, we will use marginal standardization and report the resulting population-average marginal relative risk and risk difference with their 95% confidence intervals</p></li>
</ul>
<p><strong>Notes on simulating a realistic dataset:</strong></p>
<ul>
<li><p>Reuse the helper functions from chapter 2.2, incl.&nbsp;conservative gamma distribution for u_j</p></li>
<li><p>Causal structure:</p>
<ul>
<li><p>Cluster latent effect (u_j) influences both, baseline AB prescription rate (through alpha, the correlation strength between baseline and u_j) and attendance rate (through att_corr_target) and directly affects the outcome via the cluster random effect</p></li>
<li><p>Baseline AB prescription rate directly affects the outcome (via beta_baseline), representing residual correlation beyond the shared cluster effect alpha</p></li>
<li><p>Attendance rate directly affects the outcome (via beta_att), representing residual correlation beyond the shared cluster effect att_corr_target</p></li>
<li><p>=&gt; baseline_rate and attendance both directly push the outcome (via beta_baseline and beta_att) and share correlation with u_j (i.e., indirectly push the outcome)</p></li>
<li><p>=&gt; all of the above in the sense of: “Larger clusters (=higher attendance rate) -&gt; higher AB prescription rate at endline” and “Clusters with higher AB prescription rate at baseline -&gt; higher prescription rate at endline”</p></li>
<li><p>Treatment (arm 1) directly affects the outcome (through beta_1), but correlation above and noise below masking it</p></li>
</ul></li>
<li><p>Add some baseline noise (e.g.&nbsp;tau = 0.45) ensuring that even clusters with the same u_j will show some variability in their observed baseline_rate</p></li>
<li><p>alpha (correlation baseline_rate with u_j): e.g.&nbsp;a value of 0.3 means 30% of the variation in the baseline logit is driven by u_j (i.e.&nbsp;drives true cluster tendency or the “cluster-to-cluster variation” at baseline, which also has an impact on the outcome), while the remaining comes from independent measurement noise.</p></li>
<li><p>Produce an individual-level dataset, not cluster-level only - as the real-life dataset will look like and in case we also want to add individual-level correlations</p></li>
</ul>
<section id="simulate-one-dataset-and-check-some-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="simulate-one-dataset-and-check-some-diagnostics"><strong>(3.1) Simulate one dataset and check some diagnostics</strong></h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="do">## We use the helper functions from chapter 2.2</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co"># icc_to_sigma</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># generate_u</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># generate_cluster_sizes</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co"># p_to_beta0</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># p0_p1_to_OR</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="do">## General parameters</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20250809</span>)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>n_clusters <span class="ot">&lt;-</span> <span class="dv">26</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>m_mean <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>CV <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>p0 <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fl">0.50</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>OR <span class="ot">&lt;-</span> <span class="fu">p0_p1_to_OR</span>(p0, p1)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fl">0.20</span> <span class="co"># ICC (on latent logit scale)</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>re_dist <span class="ot">&lt;-</span> <span class="st">"gamma"</span> <span class="co"># distribution for u_j, keep it conservative</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Individual-level covariates</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>age_mean <span class="ot">&lt;-</span> <span class="dv">35</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>age_sd <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>sex_prob <span class="ot">&lt;-</span> <span class="fl">0.48</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="do">## Generate cluster structure</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>sizes <span class="ot">&lt;-</span> <span class="fu">generate_cluster_sizes</span>(n_clusters, m_mean, CV)</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>sigma_b <span class="ot">&lt;-</span> <span class="fu">icc_to_sigma</span>(rho)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>u_j <span class="ot">&lt;-</span> <span class="fu">generate_u</span>(n_clusters, sigma_b, <span class="at">dist =</span> re_dist)</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>arm_assign <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">length.out =</span> n_clusters))</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="co"># First important thing to mimic: AB prescription rate at baseline</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a><span class="co"># alpha controls how much the baseline rate depends on the same latent cluster effect</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a><span class="co"># The bigger alpha, the more high-baseline clusters will also tend to have high endline outcomes indirectly, because u_j is reused in the outcome model =&gt; indirect correlation</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline AB prescription rate is explained by u_j + random noise eps + global average level gamma0.</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>gamma0 <span class="ot">&lt;-</span> <span class="fu">qlogis</span>(p0) <span class="co"># the average cluster-level log-odds of baseline antibiotic prescription</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.3</span> <span class="co"># how much baseline (logit) depends on u_j (i.e. the latent cluster effect); 0 would be no correlation (0-1)</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fl">0.45</span> <span class="co"># the residual variation (SD) in baseline log-odds not explained by u_j, i.e. the random measurement noise</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>eps <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_clusters, <span class="dv">0</span>, tau)</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>logit_b <span class="ot">&lt;-</span> gamma0 <span class="sc">+</span> alpha <span class="sc">*</span> u_j <span class="sc">+</span> eps <span class="co"># putting it all together</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>baseline_rate <span class="ot">&lt;-</span> <span class="fu">plogis</span>(logit_b) <span class="co"># map back to probability scale</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Second important thing to mimic: Attendance rate at baseline (see prelim data Nina)</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Easier, since it’s approximately normally distributed (per year is large enough)</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a><span class="co"># attendance = mean + (signal) + (noise)</span></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>mean_att_year <span class="ot">&lt;-</span> <span class="dv">7786</span></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>sd_att_year   <span class="ot">&lt;-</span> <span class="dv">3967</span></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>att_corr_target <span class="ot">&lt;-</span> <span class="fl">0.2</span> <span class="co"># weak to moderate positive correlation between the latent cluster effect and attendance, so high-prescribers (positive u_j) will tend to be at higher attendance clinics.</span></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>sd_uj <span class="ot">&lt;-</span> <span class="fu">sd</span>(u_j)</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>att_u_coef <span class="ot">&lt;-</span> att_corr_target <span class="sc">*</span> sd_att_year <span class="sc">/</span> sd_uj <span class="co"># the signal. for each +1 SD in u_j, attendance increases by ~1,760 patients per year.</span></span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>sd_att_noise <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(sd_att_year<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> att_corr_target<span class="sc">^</span><span class="dv">2</span>)) <span class="co"># rest is noise</span></span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>attendance_year_raw <span class="ot">&lt;-</span> mean_att_year <span class="sc">+</span> att_u_coef <span class="sc">*</span> u_j <span class="sc">+</span></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">rnorm</span>(n_clusters, <span class="dv">0</span>, sd_att_noise)</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>attendance_year <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">0</span>, <span class="fu">round</span>(attendance_year_raw))</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>attendance_month <span class="ot">&lt;-</span> attendance_year <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Third, the island: uncorrelated binary covariate</span></span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>island <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_clusters, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a><span class="do">## Fixed effects on outcome, direct correlations on outcome</span></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> <span class="fu">p_to_beta0</span>(p0) <span class="co"># intercept</span></span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>beta1 <span class="ot">&lt;-</span> <span class="fu">log</span>(OR) <span class="co"># intervention effect</span></span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>beta_baseline <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># how strongly the baseline rate predicts the endline outcome, independent of u_j</span></span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>beta_island <span class="ot">&lt;-</span> <span class="fl">0.0</span> <span class="co"># no correlation</span></span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>beta_att_per1000 <span class="ot">&lt;-</span> <span class="fl">0.02</span> <span class="co"># how strongly attendance affects the outcome, independent of u_j (per 1000 pats/y)</span></span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>beta_att <span class="ot">&lt;-</span> beta_att_per1000 <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>beta0_adj <span class="ot">&lt;-</span> beta0 <span class="sc">-</span> <span class="fl">1.0</span> <span class="co"># after including u_j, baseline_rate, attendance, etc., the overall mean outcome probability can drift because of the nonlinear logistic function. Stabilize.</span></span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a><span class="do">## Simulate individual-level data</span></span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>ind_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="at">length =</span> n_clusters)</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="fu">seq_len</span>(n_clusters)){</span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>  nj <span class="ot">&lt;-</span> sizes[j]</span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a>  age_j <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nj, <span class="at">mean =</span> age_mean, <span class="at">sd =</span> age_sd) <span class="co"># draw from normal</span></span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a>  sex_j <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(nj, <span class="dv">1</span>, <span class="at">prob =</span> sex_prob) <span class="co"># draw from bernoulli</span></span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>  logit_baseline_j <span class="ot">&lt;-</span> <span class="fu">qlogis</span>(baseline_rate[j]) <span class="co"># back to logit</span></span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the log-odds of antibiotic prescription for all individuals in cluster j (same cluster-level predictors for all)</span></span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>  linpred_j <span class="ot">&lt;-</span> beta0_adj <span class="sc">+</span></span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a>               beta1 <span class="sc">*</span> arm_assign[j] <span class="sc">+</span></span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>               beta_baseline <span class="sc">*</span> logit_baseline_j <span class="sc">+</span></span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a>               beta_att <span class="sc">*</span> attendance_year[j] <span class="sc">+</span></span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a>               beta_island <span class="sc">*</span> island[j] <span class="sc">+</span></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a>               u_j[j] <span class="co"># latent cluster random effect</span></span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a>  p_ij <span class="ot">&lt;-</span> <span class="fu">plogis</span>(linpred_j) <span class="co"># Predicted probability of receiving an antibiotic for each individual in cluster j. Since all individuals in a cluster share the same cluster-level covariates, p_ij is identical for everyone in the cluster (unless we later include individual-level predictors...)</span></span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>  y_ij <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(nj, <span class="dv">1</span>, p_ij) <span class="co"># the outcome; bernoulli with probability p_ij</span></span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save data for this one cluster</span></span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a>  ind_list[[j]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster =</span> j,</span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> arm_assign[j],</span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> age_j,</span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex =</span> sex_j,</span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">attendance_year =</span> attendance_year[j],</span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">attendance_month =</span> attendance_month[j],</span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">island =</span> island[j],</span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline_rate =</span> baseline_rate[j],</span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">u_j =</span> u_j[j],</span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> p_ij,</span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y_ij</span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a>df_ind <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, ind_list)</span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a><span class="do">## Cluster-level summary, aggregate at cluster-level</span></span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a>df_cluster <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(y <span class="sc">~</span> cluster <span class="sc">+</span> arm, <span class="at">data =</span> df_ind, sum) <span class="co"># aggregate number of outcomes</span></span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>df_cluster<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(y <span class="sc">~</span> cluster, <span class="at">data =</span> df_ind, length)<span class="sc">$</span>y <span class="co"># count number of ind =&gt; cluster size</span></span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a>cluster_meta <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster =</span> <span class="fu">seq_len</span>(n_clusters),</span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a>  <span class="at">arm =</span> arm_assign,</span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">attendance_year =</span> attendance_year,</span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">attendance_month =</span> attendance_month,</span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">island =</span> island,</span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_rate =</span> baseline_rate,</span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a>  <span class="at">u_j =</span> u_j</span>
<span id="cb48-117"><a href="#cb48-117" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-118"><a href="#cb48-118" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> <span class="fu">merge</span>(df_cluster, cluster_meta, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"cluster"</span>,<span class="st">"arm"</span>))</span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> df_sim[<span class="fu">order</span>(df_sim<span class="sc">$</span>cluster),</span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">c</span>(<span class="st">"cluster"</span>,<span class="st">"arm"</span>,<span class="st">"size"</span>,<span class="st">"y"</span>,<span class="st">"baseline_rate"</span>,</span>
<span id="cb48-121"><a href="#cb48-121" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"attendance_year"</span>,<span class="st">"attendance_month"</span>,</span>
<span id="cb48-122"><a href="#cb48-122" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"island"</span>,<span class="st">"u_j"</span>)]</span>
<span id="cb48-123"><a href="#cb48-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-124"><a href="#cb48-124" aria-hidden="true" tabindex="-1"></a><span class="do">## Diagnostics</span></span>
<span id="cb48-125"><a href="#cb48-125" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Attendance (year): mean ="</span>, <span class="fu">mean</span>(attendance_year),</span>
<span id="cb48-126"><a href="#cb48-126" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SD ="</span>, <span class="fu">sd</span>(attendance_year),</span>
<span id="cb48-127"><a href="#cb48-127" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CV ="</span>, <span class="fu">round</span>(<span class="fu">sd</span>(attendance_year)<span class="sc">/</span><span class="fu">mean</span>(attendance_year),<span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Attendance (year): mean = 7049 SD = 4585.651 CV = 0.65 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Target corr (attendance,u_j) ="</span>, att_corr_target,</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Observed corr ="</span>, <span class="fu">round</span>(<span class="fu">cor</span>(attendance_year, u_j),<span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Target corr (attendance,u_j) = 0.2 Observed corr = 0.27 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean baseline_rate ="</span>, <span class="fu">round</span>(<span class="fu">mean</span>(baseline_rate),<span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean baseline_rate = 0.739 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Beta_att (per 1000 patients/year) ="</span>, beta_att_per1000,</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"=&gt; clinic with 1000 more patients/year has OR ="</span>, <span class="fu">round</span>(<span class="fu">exp</span>(beta_att_per1000),<span class="dv">3</span>), <span class="st">" of prescribing antibiotics</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Beta_att (per 1000 patients/year) = 0.02 =&gt; clinic with 1000 more patients/year has OR = 1.02  of prescribing antibiotics</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"First few cluster-level rows:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>First few cluster-level rows:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(df_sim, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   cluster arm size  y baseline_rate attendance_year attendance_month island
1        1   0   38 20     0.7218079             484         40.33333      1
12       2   1   45 13     0.6655458            3314        276.16667      1
20       3   0   45 24     0.4800860            5358        446.50000      1
21       4   1   45 34     0.9107505           17338       1444.83333      1
22       5   0   42 29     0.7854459            8159        679.91667      0
23       6   0   41 41     0.8635783            2278        189.83333      0
24       7   1   46 14     0.6704538           11584        965.33333      1
25       8   0   40 28     0.6571218           17009       1417.41667      1
26       9   0   43 19     0.7625871            1313        109.41667      1
2       10   1   40 26     0.8911799            6660        555.00000      0
           u_j
1  -0.48591058
12 -0.18692341
20 -0.06920874
21  1.41603543
22  0.30221964
23  0.93496870
24 -0.44639639
25 -0.25064723
26 -0.98577972
2  -0.08530853</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"First few individual-level rows:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>First few individual-level rows:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(df_ind, <span class="dv">50</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   cluster arm       age sex attendance_year attendance_month island
1        1   0 31.141817   0             484         40.33333      1
2        1   0 38.836085   0             484         40.33333      1
3        1   0 36.036553   0             484         40.33333      1
4        1   0 43.068029   0             484         40.33333      1
5        1   0 33.707015   0             484         40.33333      1
6        1   0 29.838524   1             484         40.33333      1
7        1   0 41.398540   1             484         40.33333      1
8        1   0 45.060521   0             484         40.33333      1
9        1   0 18.519409   1             484         40.33333      1
10       1   0 21.600997   1             484         40.33333      1
11       1   0 26.200323   0             484         40.33333      1
12       1   0 37.607236   0             484         40.33333      1
13       1   0 20.627753   0             484         40.33333      1
14       1   0 55.024518   0             484         40.33333      1
15       1   0 44.204938   1             484         40.33333      1
16       1   0 42.996016   0             484         40.33333      1
17       1   0 29.151747   1             484         40.33333      1
18       1   0 20.397419   1             484         40.33333      1
19       1   0 58.662140   0             484         40.33333      1
20       1   0 38.238681   0             484         40.33333      1
21       1   0 50.367882   0             484         40.33333      1
22       1   0 43.097409   1             484         40.33333      1
23       1   0 36.927717   0             484         40.33333      1
24       1   0 41.338233   0             484         40.33333      1
25       1   0 44.548945   1             484         40.33333      1
26       1   0 25.789525   0             484         40.33333      1
27       1   0 45.963908   1             484         40.33333      1
28       1   0 31.667433   1             484         40.33333      1
29       1   0 30.456096   0             484         40.33333      1
30       1   0 30.160906   0             484         40.33333      1
31       1   0 41.426915   0             484         40.33333      1
32       1   0 51.759286   1             484         40.33333      1
33       1   0 26.230610   0             484         40.33333      1
34       1   0 41.536981   0             484         40.33333      1
35       1   0 49.981626   0             484         40.33333      1
36       1   0 31.490423   1             484         40.33333      1
37       1   0 39.726115   1             484         40.33333      1
38       1   0 41.955090   0             484         40.33333      1
39       2   1  9.124056   1            3314        276.16667      1
40       2   1 42.462407   1            3314        276.16667      1
41       2   1 48.208422   0            3314        276.16667      1
42       2   1 49.436545   1            3314        276.16667      1
43       2   1 14.160414   0            3314        276.16667      1
44       2   1 15.872495   0            3314        276.16667      1
45       2   1 50.214321   0            3314        276.16667      1
46       2   1 41.816423   0            3314        276.16667      1
47       2   1 38.097800   1            3314        276.16667      1
48       2   1 26.032686   0            3314        276.16667      1
49       2   1  5.919001   1            3314        276.16667      1
50       2   1 26.229268   1            3314        276.16667      1
   baseline_rate        u_j         p y
1      0.7218079 -0.4859106 0.5247561 1
2      0.7218079 -0.4859106 0.5247561 0
3      0.7218079 -0.4859106 0.5247561 0
4      0.7218079 -0.4859106 0.5247561 1
5      0.7218079 -0.4859106 0.5247561 0
6      0.7218079 -0.4859106 0.5247561 0
7      0.7218079 -0.4859106 0.5247561 1
8      0.7218079 -0.4859106 0.5247561 0
9      0.7218079 -0.4859106 0.5247561 0
10     0.7218079 -0.4859106 0.5247561 1
11     0.7218079 -0.4859106 0.5247561 1
12     0.7218079 -0.4859106 0.5247561 1
13     0.7218079 -0.4859106 0.5247561 1
14     0.7218079 -0.4859106 0.5247561 0
15     0.7218079 -0.4859106 0.5247561 1
16     0.7218079 -0.4859106 0.5247561 1
17     0.7218079 -0.4859106 0.5247561 1
18     0.7218079 -0.4859106 0.5247561 0
19     0.7218079 -0.4859106 0.5247561 0
20     0.7218079 -0.4859106 0.5247561 1
21     0.7218079 -0.4859106 0.5247561 0
22     0.7218079 -0.4859106 0.5247561 0
23     0.7218079 -0.4859106 0.5247561 1
24     0.7218079 -0.4859106 0.5247561 0
25     0.7218079 -0.4859106 0.5247561 0
26     0.7218079 -0.4859106 0.5247561 1
27     0.7218079 -0.4859106 0.5247561 1
28     0.7218079 -0.4859106 0.5247561 1
29     0.7218079 -0.4859106 0.5247561 1
30     0.7218079 -0.4859106 0.5247561 0
31     0.7218079 -0.4859106 0.5247561 1
32     0.7218079 -0.4859106 0.5247561 1
33     0.7218079 -0.4859106 0.5247561 1
34     0.7218079 -0.4859106 0.5247561 0
35     0.7218079 -0.4859106 0.5247561 0
36     0.7218079 -0.4859106 0.5247561 0
37     0.7218079 -0.4859106 0.5247561 1
38     0.7218079 -0.4859106 0.5247561 0
39     0.6655458 -0.1869234 0.3150554 0
40     0.6655458 -0.1869234 0.3150554 0
41     0.6655458 -0.1869234 0.3150554 0
42     0.6655458 -0.1869234 0.3150554 0
43     0.6655458 -0.1869234 0.3150554 1
44     0.6655458 -0.1869234 0.3150554 0
45     0.6655458 -0.1869234 0.3150554 1
46     0.6655458 -0.1869234 0.3150554 0
47     0.6655458 -0.1869234 0.3150554 1
48     0.6655458 -0.1869234 0.3150554 0
49     0.6655458 -0.1869234 0.3150554 1
50     0.6655458 -0.1869234 0.3150554 0</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Overall N ="</span>, <span class="fu">sum</span>(df_sim<span class="sc">$</span>size), <span class="st">"individuals across"</span>, n_clusters, <span class="st">"clusters</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Overall N = 1071 individuals across 26 clusters</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute mean prescription rate per arm</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>arm_rates <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(y <span class="sc">~</span> arm, <span class="at">data =</span> df_ind, mean)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>arm_rates<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">round</span>(arm_rates<span class="sc">$</span>y, <span class="dv">3</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(arm_rates))){</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Arm"</span>, arm_rates<span class="sc">$</span>arm[i], <span class="st">"observed prescription rate:"</span>, arm_rates<span class="sc">$</span>y[i], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Arm 0 observed prescription rate: 0.622 
Arm 1 observed prescription rate: 0.474 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">list</span>(<span class="at">individual =</span> df_ind, <span class="at">cluster =</span> df_sim)) <span class="co"># prevents automatic printing to console</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="the-analysis-approach-step-by-step" class="level2">
<h2 class="anchored" data-anchor-id="the-analysis-approach-step-by-step"><strong>(3.2) The analysis approach, step-by-step</strong></h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Precompute spline basis for age and convert to numeric</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>age_spline <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ns</span>(df_ind<span class="sc">$</span>age, <span class="at">knots =</span> <span class="fu">quantile</span>(df_ind<span class="sc">$</span>age, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="fl">0.9</span>))))</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(age_spline) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"age_spline"</span>, <span class="fu">seq_len</span>(<span class="fu">ncol</span>(age_spline)))</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>age_spline[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(age_spline, as.numeric)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>df_ind <span class="ot">&lt;-</span> <span class="fu">cbind</span>(df_ind, age_spline)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Ensure factor levels</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>df_ind<span class="sc">$</span>arm <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_ind<span class="sc">$</span>arm, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="co"># 0 = control, 1 = intervention</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>df_ind<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_ind<span class="sc">$</span>sex, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="co"># 0 = male, 1 = female</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>df_ind<span class="sc">$</span>island <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_ind<span class="sc">$</span>island, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="co"># 0 = "Unguja", 1 = "Pemba"</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit GLMM (fully adjusted)</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>spline_cols <span class="ot">&lt;-</span> <span class="fu">colnames</span>(df_ind)[<span class="fu">grepl</span>(<span class="st">"^age_spline"</span>, <span class="fu">colnames</span>(df_ind))]</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="st">"y ~ arm + baseline_rate + attendance_year + island + sex +"</span>,</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste</span>(spline_cols, <span class="at">collapse=</span><span class="st">" + "</span>))</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>model_pql <span class="ot">&lt;-</span> <span class="fu">glmmPQL</span>(</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed =</span> form,</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">random =</span> <span class="sc">~</span><span class="dv">1</span> <span class="sc">|</span> cluster,</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>),</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_ind,</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_pql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by maximum likelihood
  Data: df_ind 
  AIC BIC logLik
   NA  NA     NA

Random effects:
 Formula: ~1 | cluster
        (Intercept)  Residual
StdDev:   0.5420936 0.9789434

Variance function:
 Structure: fixed weights
 Formula: ~invwt 
Fixed effects:  y ~ arm + baseline_rate + attendance_year + island + sex + age_spline1 +      age_spline2 + age_spline3 + age_spline4 
                    Value Std.Error   DF   t-value p-value
(Intercept)     -3.571481 1.2187709 1040 -2.930396  0.0035
arm1            -1.015317 0.2652498   21 -3.827776  0.0010
baseline_rate    5.998138 1.3510521   21  4.439605  0.0002
attendance_year  0.000041 0.0000309   21  1.334604  0.1963
island1         -0.023031 0.2777473   21 -0.082919  0.9347
sex1             0.103924 0.1310441 1040  0.793048  0.4279
age_spline1     -0.506236 0.6176898 1040 -0.819563  0.4127
age_spline2     -0.109424 0.5745078 1040 -0.190465  0.8490
age_spline3     -0.534784 1.4827593 1040 -0.360668  0.7184
age_spline4      0.342034 0.9434878 1040  0.362521  0.7170
 Correlation: 
                (Intr) arm1   bsln_r attnd_ islnd1 sex1   ag_sp1 ag_sp2 ag_sp3
arm1             0.117                                                        
baseline_rate   -0.809 -0.249                                                 
attendance_year -0.046 -0.159 -0.066                                          
island1         -0.253 -0.075  0.234 -0.328                                   
sex1            -0.030 -0.010 -0.004  0.002 -0.005                            
age_spline1     -0.508  0.024 -0.003 -0.032  0.008 -0.028                     
age_spline2     -0.456  0.018  0.014 -0.023 -0.022  0.001  0.633              
age_spline3     -0.523  0.024  0.008 -0.028  0.004 -0.015  0.875  0.699       
age_spline4     -0.047  0.012 -0.005 -0.018  0.040  0.022  0.251 -0.299  0.333

Standardized Within-Group Residuals:
       Min         Q1        Med         Q3        Max 
-3.8575737 -0.9128196  0.3404748  0.8587993  1.7024345 

Number of Observations: 1071
Number of Groups: 26 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Now, let's make a few comparisons</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1. Unadjusted OR</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>form_unadj <span class="ot">&lt;-</span> y <span class="sc">~</span> arm</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>model_unadj <span class="ot">&lt;-</span> <span class="fu">glmmPQL</span>(</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed =</span> form_unadj,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">random =</span> <span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>cluster,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>),</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_ind,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>coef_name_unadj <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^arm"</span>, <span class="fu">names</span>(<span class="fu">fixef</span>(model_unadj)), <span class="at">value=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>coef_arm_unadj <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_unadj)[coef_name_unadj]</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>se_arm_unadj <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_unadj)<span class="sc">$</span>tTable[coef_name_unadj,<span class="st">"Std.Error"</span>]</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>df_unadj <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_ind<span class="sc">$</span>cluster)) <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">fixef</span>(model_unadj))</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>t_stat_unadj <span class="ot">&lt;-</span> coef_arm_unadj <span class="sc">/</span> se_arm_unadj</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>p_val_unadj <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pt</span>(<span class="sc">-</span><span class="fu">abs</span>(t_stat_unadj), <span class="at">df=</span>df_unadj) <span class="co"># small sample correction</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>OR_unadj <span class="ot">&lt;-</span> <span class="fu">exp</span>(coef_arm_unadj)</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>CI_unadj <span class="ot">&lt;-</span> <span class="fu">exp</span>(coef_arm_unadj <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fu">qt</span>(<span class="fl">0.975</span>, <span class="at">df=</span>df_unadj)<span class="sc">*</span>se_arm_unadj)</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 2. Adjusted for stratification variables only</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>form_strata <span class="ot">&lt;-</span> y <span class="sc">~</span> arm <span class="sc">+</span> baseline_rate <span class="sc">+</span> attendance_year <span class="sc">+</span> island</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>model_strata <span class="ot">&lt;-</span> <span class="fu">glmmPQL</span>(</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed =</span> form_strata,</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">random =</span> <span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>cluster,</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>),</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_ind,</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>coef_name_strata <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^arm"</span>, <span class="fu">names</span>(<span class="fu">fixef</span>(model_strata)), <span class="at">value=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>coef_arm_strata <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_strata)[coef_name_strata]</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>se_arm_strata <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_strata)<span class="sc">$</span>tTable[coef_name_strata,<span class="st">"Std.Error"</span>]</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>df_strata <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_ind<span class="sc">$</span>cluster)) <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">fixef</span>(model_strata))</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>t_stat_strata <span class="ot">&lt;-</span> coef_arm_strata <span class="sc">/</span> se_arm_strata</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>p_val_strata <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pt</span>(<span class="sc">-</span><span class="fu">abs</span>(t_stat_strata), <span class="at">df=</span>df_strata) <span class="co"># small sample correction</span></span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>OR_strata <span class="ot">&lt;-</span> <span class="fu">exp</span>(coef_arm_strata)</span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>CI_strata <span class="ot">&lt;-</span> <span class="fu">exp</span>(coef_arm_strata <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fu">qt</span>(<span class="fl">0.975</span>, <span class="at">df=</span>df_strata)<span class="sc">*</span>se_arm_strata)</span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a><span class="do">## 3. Fully adjusted, age as spline (see main model above)</span></span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>coef_name_full <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^arm"</span>, <span class="fu">names</span>(<span class="fu">fixef</span>(model_pql)), <span class="at">value=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a>coef_arm_full <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_pql)[coef_name_full]</span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a>se_arm_full <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_pql)<span class="sc">$</span>tTable[coef_name_full,<span class="st">"Std.Error"</span>]</span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a>df_full <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_ind<span class="sc">$</span>cluster)) <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">fixef</span>(model_pql))</span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a>t_stat_full <span class="ot">&lt;-</span> coef_arm_full <span class="sc">/</span> se_arm_full</span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a>p_val_full <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pt</span>(<span class="sc">-</span><span class="fu">abs</span>(t_stat_full), <span class="at">df=</span>df_full) <span class="co"># small sample correction</span></span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a>OR_full <span class="ot">&lt;-</span> <span class="fu">exp</span>(coef_arm_full)</span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a>CI_full <span class="ot">&lt;-</span> <span class="fu">exp</span>(coef_arm_full <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fu">qt</span>(<span class="fl">0.975</span>, <span class="at">df=</span>df_full)<span class="sc">*</span>se_arm_full)</span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a><span class="do">## 4. And finally, calculate RR for the main model, using marginal standardization</span></span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a>RR_model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">avg_comparisons</span>(model_pql, <span class="at">variables=</span><span class="st">"arm"</span>, <span class="at">type=</span><span class="st">"response"</span>, <span class="at">comparison=</span><span class="st">"ratio"</span>)</span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(RR_model)){</span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a>  rr <span class="ot">&lt;-</span> RR_model<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a>  rr_cl <span class="ot">&lt;-</span> RR_model<span class="sc">$</span>conf.low[<span class="dv">1</span>]</span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a>  rr_ch <span class="ot">&lt;-</span> RR_model<span class="sc">$</span>conf.high[<span class="dv">1</span>]</span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a>  rr <span class="ot">&lt;-</span> rr_cl <span class="ot">&lt;-</span> rr_ch <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine it all into a table</span></span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a>results_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">Metric =</span> <span class="fu">c</span>(<span class="st">"Unadjusted"</span>, <span class="st">"Adjusted for strat only"</span>, <span class="st">"Fully adjusted; age spline"</span>),</span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">OR =</span> <span class="fu">c</span>(<span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, OR_unadj),</span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a>         <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, OR_strata),</span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a>         <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, OR_full)),</span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_lower =</span> <span class="fu">c</span>(<span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, CI_unadj[<span class="dv">1</span>]),</span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a>               <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, CI_strata[<span class="dv">1</span>]),</span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a>               <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, CI_full[<span class="dv">1</span>])),</span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_upper =</span> <span class="fu">c</span>(<span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, CI_unadj[<span class="dv">2</span>]),</span>
<span id="cb71-71"><a href="#cb71-71" aria-hidden="true" tabindex="-1"></a>               <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, CI_strata[<span class="dv">2</span>]),</span>
<span id="cb71-72"><a href="#cb71-72" aria-hidden="true" tabindex="-1"></a>               <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, CI_full[<span class="dv">2</span>])),</span>
<span id="cb71-73"><a href="#cb71-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">t_based_p_value =</span> <span class="fu">c</span>(<span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, p_val_unadj), <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, p_val_strata), <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, p_val_full)),</span>
<span id="cb71-74"><a href="#cb71-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">RR =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, rr)),</span>
<span id="cb71-75"><a href="#cb71-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">RR_CI_lower =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, rr_cl)),</span>
<span id="cb71-76"><a href="#cb71-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">RR_CI_upper =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, rr_ch))</span>
<span id="cb71-77"><a href="#cb71-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-78"><a href="#cb71-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-79"><a href="#cb71-79" aria-hidden="true" tabindex="-1"></a>results_table <span class="sc">%&gt;%</span></span>
<span id="cb71-80"><a href="#cb71-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"html"</span>, <span class="at">caption=</span><span class="st">"Intervention effect: OR and RR with 95% CI (single simulation)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-81"><a href="#cb71-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options=</span><span class="st">"striped"</span>, <span class="at">full_width=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<caption>Intervention effect: OR and RR with 95% CI (single simulation)</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Metric</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">OR</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">CI_lower</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">CI_upper</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">t_based_p_value</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">RR</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">RR_CI_lower</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">RR_CI_upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Unadjusted</td>
<td style="text-align: left;">0.490</td>
<td style="text-align: left;">0.239</td>
<td style="text-align: left;">1.005</td>
<td style="text-align: left;">0.052</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">Adjusted for strat only</td>
<td style="text-align: left;">0.362</td>
<td style="text-align: left;">0.208</td>
<td style="text-align: left;">0.631</td>
<td style="text-align: left;">0.001</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Fully adjusted; age spline</td>
<td style="text-align: left;">0.362</td>
<td style="text-align: left;">0.206</td>
<td style="text-align: left;">0.636</td>
<td style="text-align: left;">0.001</td>
<td style="text-align: left;">0.670</td>
<td style="text-align: left;">0.533</td>
<td style="text-align: left;">0.806</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>CAVE: This is 1 randomly simulated dataset.</p>
<p>Due to correlation structure the adjustment for stratification factors increases power and precision. The further adjustment for individual-level covariates does not change much, makes sense, since there is no built-in correlation at that level in the simulation structure.</p>
<p>RR only constructed for primary model (fully adjusted model)</p>
</section>
<section id="put-all-together-and-simulate-the-power" class="level2">
<h2 class="anchored" data-anchor-id="put-all-together-and-simulate-the-power"><strong>(3.3) Put all together and simulate the power</strong></h2>
<p>1000 simulations, based on dataset simulation (Chapter 3.1) and primary analysis model (Chapter 3.2)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>simulate_crt <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_clusters =</span> <span class="dv">26</span>,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">m_mean =</span> <span class="dv">40</span>,</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">CV =</span> <span class="fl">0.1</span>,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">p0 =</span> <span class="fl">0.75</span>,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1 =</span> <span class="fl">0.50</span>,</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.2</span>,</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">re_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="co"># weak-moderate correlation between u_j and baseline AB prescription rate</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau =</span> <span class="fl">0.45</span>, <span class="co"># SD of baseline noise</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_att_year =</span> <span class="dv">7786</span>,</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_att_year =</span> <span class="dv">3967</span>,</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">att_corr_target =</span> <span class="fl">0.2</span>, <span class="co"># weak-moderate correlation between u_j and attendance rate</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_baseline =</span> <span class="fl">0.2</span>, <span class="co"># weak-moderate pos correlation: baseline AB rate -&gt; outcome, independent of u_j</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_att_per1000 =</span> <span class="fl">0.02</span>, <span class="co"># weak-moderate pos correlation: attendance rate -&gt; outcome, independent of u_j</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_mean =</span> <span class="dv">35</span>,</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_sd =</span> <span class="dv">12</span>,</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">sex_prob =</span> <span class="fl">0.48</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (1) Compute OR and intercept</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>  OR <span class="ot">&lt;-</span> <span class="fu">p0_p1_to_OR</span>(p0, p1)</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="ot">&lt;-</span> <span class="fu">p_to_beta0</span>(p0)</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>  beta1 <span class="ot">&lt;-</span> <span class="fu">log</span>(OR)</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  beta_att <span class="ot">&lt;-</span> beta_att_per1000 <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  beta0_adj <span class="ot">&lt;-</span> beta0 <span class="sc">-</span> <span class="fl">1.0</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (2) Generate clusters</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>  sizes <span class="ot">&lt;-</span> <span class="fu">generate_cluster_sizes</span>(n_clusters, m_mean, CV)</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="ot">&lt;-</span> <span class="fu">icc_to_sigma</span>(rho)</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>  u_j <span class="ot">&lt;-</span> <span class="fu">generate_u</span>(n_clusters, sigma_b, <span class="at">dist =</span> re_dist)</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>  arm_assign <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">length.out =</span> n_clusters))</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (3) Baseline AB prescription rate</span></span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_clusters, <span class="dv">0</span>, tau)</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>  logit_b <span class="ot">&lt;-</span> <span class="fu">qlogis</span>(p0) <span class="sc">+</span> alpha <span class="sc">*</span> u_j <span class="sc">+</span> eps</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>  baseline_rate <span class="ot">&lt;-</span> <span class="fu">plogis</span>(logit_b)</span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (4) Attendance</span></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>  sd_uj <span class="ot">&lt;-</span> <span class="fu">sd</span>(u_j)</span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>  att_u_coef <span class="ot">&lt;-</span> att_corr_target <span class="sc">*</span> sd_att_year <span class="sc">/</span> sd_uj</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>  sd_att_noise <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(sd_att_year<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> att_corr_target<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>  attendance_year_raw <span class="ot">&lt;-</span> mean_att_year <span class="sc">+</span> att_u_coef <span class="sc">*</span> u_j <span class="sc">+</span></span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">rnorm</span>(n_clusters, <span class="dv">0</span>, sd_att_noise)</span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>  attendance_year <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">0</span>, <span class="fu">round</span>(attendance_year_raw))</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>  attendance_month <span class="ot">&lt;-</span> attendance_year <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (5) Island</span></span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>  island <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_clusters, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (6) Individual-level simulation</span></span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>  ind_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="at">length =</span> n_clusters)</span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="fu">seq_len</span>(n_clusters)){</span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>    nj <span class="ot">&lt;-</span> sizes[j]</span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>    age_j <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nj, <span class="at">mean =</span> age_mean, <span class="at">sd =</span> age_sd)</span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>    sex_j <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(nj, <span class="dv">1</span>, sex_prob)</span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a>    logit_baseline_j <span class="ot">&lt;-</span> <span class="fu">qlogis</span>(baseline_rate[j])</span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a>    linpred_j <span class="ot">&lt;-</span> beta0_adj <span class="sc">+</span></span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a>                 beta1 <span class="sc">*</span> arm_assign[j] <span class="sc">+</span></span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a>                 beta_baseline <span class="sc">*</span> logit_baseline_j <span class="sc">+</span></span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a>                 beta_att <span class="sc">*</span> attendance_year[j] <span class="sc">+</span></span>
<span id="cb72-63"><a href="#cb72-63" aria-hidden="true" tabindex="-1"></a>                 u_j[j] <span class="sc">+</span></span>
<span id="cb72-64"><a href="#cb72-64" aria-hidden="true" tabindex="-1"></a>                 beta_island <span class="sc">*</span> island[j]</span>
<span id="cb72-65"><a href="#cb72-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-66"><a href="#cb72-66" aria-hidden="true" tabindex="-1"></a>    p_ij <span class="ot">&lt;-</span> <span class="fu">plogis</span>(linpred_j)</span>
<span id="cb72-67"><a href="#cb72-67" aria-hidden="true" tabindex="-1"></a>    y_ij <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(nj, <span class="dv">1</span>, p_ij)</span>
<span id="cb72-68"><a href="#cb72-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-69"><a href="#cb72-69" aria-hidden="true" tabindex="-1"></a>    ind_list[[j]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb72-70"><a href="#cb72-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">cluster =</span> j,</span>
<span id="cb72-71"><a href="#cb72-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">arm =</span> arm_assign[j],</span>
<span id="cb72-72"><a href="#cb72-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> age_j,</span>
<span id="cb72-73"><a href="#cb72-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">sex =</span> sex_j,</span>
<span id="cb72-74"><a href="#cb72-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">attendance_year =</span> attendance_year[j],</span>
<span id="cb72-75"><a href="#cb72-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">attendance_month =</span> attendance_month[j],</span>
<span id="cb72-76"><a href="#cb72-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">island =</span> island[j],</span>
<span id="cb72-77"><a href="#cb72-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline_rate =</span> baseline_rate[j],</span>
<span id="cb72-78"><a href="#cb72-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">u_j =</span> u_j[j],</span>
<span id="cb72-79"><a href="#cb72-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">p =</span> p_ij,</span>
<span id="cb72-80"><a href="#cb72-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> y_ij</span>
<span id="cb72-81"><a href="#cb72-81" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-82"><a href="#cb72-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-83"><a href="#cb72-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-84"><a href="#cb72-84" aria-hidden="true" tabindex="-1"></a>  df_ind <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, ind_list)</span>
<span id="cb72-85"><a href="#cb72-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-86"><a href="#cb72-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (7) Cluster-level summary</span></span>
<span id="cb72-87"><a href="#cb72-87" aria-hidden="true" tabindex="-1"></a>  df_cluster <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(y <span class="sc">~</span> cluster <span class="sc">+</span> arm, <span class="at">data =</span> df_ind, sum)</span>
<span id="cb72-88"><a href="#cb72-88" aria-hidden="true" tabindex="-1"></a>  df_cluster<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(y <span class="sc">~</span> cluster, <span class="at">data =</span> df_ind, length)<span class="sc">$</span>y</span>
<span id="cb72-89"><a href="#cb72-89" aria-hidden="true" tabindex="-1"></a>  cluster_meta <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb72-90"><a href="#cb72-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster =</span> <span class="fu">seq_len</span>(n_clusters),</span>
<span id="cb72-91"><a href="#cb72-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> arm_assign,</span>
<span id="cb72-92"><a href="#cb72-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">attendance_year =</span> attendance_year,</span>
<span id="cb72-93"><a href="#cb72-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">attendance_month =</span> attendance_month,</span>
<span id="cb72-94"><a href="#cb72-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">island =</span> island,</span>
<span id="cb72-95"><a href="#cb72-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline_rate =</span> baseline_rate,</span>
<span id="cb72-96"><a href="#cb72-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">u_j =</span> u_j</span>
<span id="cb72-97"><a href="#cb72-97" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-98"><a href="#cb72-98" aria-hidden="true" tabindex="-1"></a>  df_sim <span class="ot">&lt;-</span> <span class="fu">merge</span>(df_cluster, cluster_meta, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"cluster"</span>,<span class="st">"arm"</span>))</span>
<span id="cb72-99"><a href="#cb72-99" aria-hidden="true" tabindex="-1"></a>  df_sim <span class="ot">&lt;-</span> df_sim[<span class="fu">order</span>(df_sim<span class="sc">$</span>cluster),</span>
<span id="cb72-100"><a href="#cb72-100" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="st">"cluster"</span>,<span class="st">"arm"</span>,<span class="st">"size"</span>,<span class="st">"y"</span>,<span class="st">"baseline_rate"</span>,</span>
<span id="cb72-101"><a href="#cb72-101" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"attendance_year"</span>,<span class="st">"attendance_month"</span>,</span>
<span id="cb72-102"><a href="#cb72-102" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"island"</span>,<span class="st">"u_j"</span>)]</span>
<span id="cb72-103"><a href="#cb72-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-104"><a href="#cb72-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb72-105"><a href="#cb72-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">individual =</span> df_ind,</span>
<span id="cb72-106"><a href="#cb72-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster =</span> df_sim</span>
<span id="cb72-107"><a href="#cb72-107" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb72-108"><a href="#cb72-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-109"><a href="#cb72-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-110"><a href="#cb72-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Default simulation</span></span>
<span id="cb72-111"><a href="#cb72-111" aria-hidden="true" tabindex="-1"></a><span class="co"># sim_data &lt;- simulate_crt()</span></span>
<span id="cb72-112"><a href="#cb72-112" aria-hidden="true" tabindex="-1"></a><span class="co"># df_ind &lt;- sim_data$individual</span></span>
<span id="cb72-113"><a href="#cb72-113" aria-hidden="true" tabindex="-1"></a><span class="co"># df_cluster &lt;- sim_data$cluster</span></span>
<span id="cb72-114"><a href="#cb72-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-115"><a href="#cb72-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of simulations</span></span>
<span id="cb72-116"><a href="#cb72-116" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb72-117"><a href="#cb72-117" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20250809</span>)</span>
<span id="cb72-118"><a href="#cb72-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-119"><a href="#cb72-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Storage</span></span>
<span id="cb72-120"><a href="#cb72-120" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb72-121"><a href="#cb72-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">sim =</span> <span class="dv">1</span><span class="sc">:</span>n_sims,</span>
<span id="cb72-122"><a href="#cb72-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">unadj_signif =</span> <span class="cn">NA</span>,</span>
<span id="cb72-123"><a href="#cb72-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">adj_signif =</span> <span class="cn">NA</span>,</span>
<span id="cb72-124"><a href="#cb72-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_unadj =</span> <span class="cn">NA</span>,</span>
<span id="cb72-125"><a href="#cb72-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_adj =</span> <span class="cn">NA</span>,</span>
<span id="cb72-126"><a href="#cb72-126" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_unadj <span class="ot">&lt;-</span> <span class="cn">NA</span>,</span>
<span id="cb72-127"><a href="#cb72-127" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_unadj_lower <span class="ot">&lt;-</span> <span class="cn">NA</span>,</span>
<span id="cb72-128"><a href="#cb72-128" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_unadj_upper <span class="ot">&lt;-</span> <span class="cn">NA</span>,</span>
<span id="cb72-129"><a href="#cb72-129" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_adj <span class="ot">&lt;-</span> <span class="cn">NA</span>,</span>
<span id="cb72-130"><a href="#cb72-130" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_adj_lower <span class="ot">&lt;-</span> <span class="cn">NA</span>,</span>
<span id="cb72-131"><a href="#cb72-131" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_adj_upper <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb72-132"><a href="#cb72-132" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-133"><a href="#cb72-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-134"><a href="#cb72-134" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(n_sims)){</span>
<span id="cb72-135"><a href="#cb72-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-136"><a href="#cb72-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (1) Simulate trial</span></span>
<span id="cb72-137"><a href="#cb72-137" aria-hidden="true" tabindex="-1"></a>  sim_data <span class="ot">&lt;-</span> <span class="fu">simulate_crt</span>()</span>
<span id="cb72-138"><a href="#cb72-138" aria-hidden="true" tabindex="-1"></a>  df_ind <span class="ot">&lt;-</span> sim_data<span class="sc">$</span>individual</span>
<span id="cb72-139"><a href="#cb72-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-140"><a href="#cb72-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (2) Prepare age spline</span></span>
<span id="cb72-141"><a href="#cb72-141" aria-hidden="true" tabindex="-1"></a>  age_spline <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ns</span>(df_ind<span class="sc">$</span>age, </span>
<span id="cb72-142"><a href="#cb72-142" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">knots =</span> <span class="fu">quantile</span>(df_ind<span class="sc">$</span>age, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="fl">0.9</span>))))</span>
<span id="cb72-143"><a href="#cb72-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(age_spline) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"age_spline"</span>, <span class="fu">seq_len</span>(<span class="fu">ncol</span>(age_spline)))</span>
<span id="cb72-144"><a href="#cb72-144" aria-hidden="true" tabindex="-1"></a>  df_ind <span class="ot">&lt;-</span> <span class="fu">cbind</span>(df_ind, age_spline)</span>
<span id="cb72-145"><a href="#cb72-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-146"><a href="#cb72-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (3) Ensure factors</span></span>
<span id="cb72-147"><a href="#cb72-147" aria-hidden="true" tabindex="-1"></a>  df_ind<span class="sc">$</span>arm <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_ind<span class="sc">$</span>arm, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb72-148"><a href="#cb72-148" aria-hidden="true" tabindex="-1"></a>  df_ind<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_ind<span class="sc">$</span>sex, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb72-149"><a href="#cb72-149" aria-hidden="true" tabindex="-1"></a>  df_ind<span class="sc">$</span>island <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_ind<span class="sc">$</span>island, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb72-150"><a href="#cb72-150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-151"><a href="#cb72-151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (4) Unadjusted model</span></span>
<span id="cb72-152"><a href="#cb72-152" aria-hidden="true" tabindex="-1"></a>  model_unadj <span class="ot">&lt;-</span> <span class="fu">glmmPQL</span>(</span>
<span id="cb72-153"><a href="#cb72-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> y <span class="sc">~</span> arm,</span>
<span id="cb72-154"><a href="#cb72-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">random =</span> <span class="sc">~</span><span class="dv">1</span> <span class="sc">|</span> cluster,</span>
<span id="cb72-155"><a href="#cb72-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>),</span>
<span id="cb72-156"><a href="#cb72-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df_ind,</span>
<span id="cb72-157"><a href="#cb72-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb72-158"><a href="#cb72-158" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-159"><a href="#cb72-159" aria-hidden="true" tabindex="-1"></a>  beta1_unadj <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_unadj)[<span class="st">"arm1"</span>]</span>
<span id="cb72-160"><a href="#cb72-160" aria-hidden="true" tabindex="-1"></a>  se1_unadj   <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_unadj)<span class="sc">$</span>tTable[<span class="st">"arm1"</span>,<span class="st">"Std.Error"</span>]</span>
<span id="cb72-161"><a href="#cb72-161" aria-hidden="true" tabindex="-1"></a>  t1 <span class="ot">&lt;-</span> beta1_unadj <span class="sc">/</span> se1_unadj</span>
<span id="cb72-162"><a href="#cb72-162" aria-hidden="true" tabindex="-1"></a>  df1 <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_ind<span class="sc">$</span>cluster)) <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">fixef</span>(model_unadj))</span>
<span id="cb72-163"><a href="#cb72-163" aria-hidden="true" tabindex="-1"></a>  pval_unadj <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pt</span>(<span class="sc">-</span><span class="fu">abs</span>(t1), <span class="at">df=</span>df1)</span>
<span id="cb72-164"><a href="#cb72-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-165"><a href="#cb72-165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (5) Fully adjusted model</span></span>
<span id="cb72-166"><a href="#cb72-166" aria-hidden="true" tabindex="-1"></a>  spline_cols <span class="ot">&lt;-</span> <span class="fu">colnames</span>(df_ind)[<span class="fu">grepl</span>(<span class="st">"^age_spline"</span>, <span class="fu">colnames</span>(df_ind))]</span>
<span id="cb72-167"><a href="#cb72-167" aria-hidden="true" tabindex="-1"></a>  form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(</span>
<span id="cb72-168"><a href="#cb72-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"y ~ arm + baseline_rate + attendance_year + island + sex +"</span>,</span>
<span id="cb72-169"><a href="#cb72-169" aria-hidden="true" tabindex="-1"></a>          <span class="fu">paste</span>(spline_cols, <span class="at">collapse=</span><span class="st">" + "</span>))</span>
<span id="cb72-170"><a href="#cb72-170" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-171"><a href="#cb72-171" aria-hidden="true" tabindex="-1"></a>  model_adj <span class="ot">&lt;-</span> <span class="fu">glmmPQL</span>(</span>
<span id="cb72-172"><a href="#cb72-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> form,</span>
<span id="cb72-173"><a href="#cb72-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">random =</span> <span class="sc">~</span><span class="dv">1</span> <span class="sc">|</span> cluster,</span>
<span id="cb72-174"><a href="#cb72-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>),</span>
<span id="cb72-175"><a href="#cb72-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df_ind,</span>
<span id="cb72-176"><a href="#cb72-176" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb72-177"><a href="#cb72-177" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-178"><a href="#cb72-178" aria-hidden="true" tabindex="-1"></a>  beta1_adj <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_adj)[<span class="st">"arm1"</span>]</span>
<span id="cb72-179"><a href="#cb72-179" aria-hidden="true" tabindex="-1"></a>  se1_adj   <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_adj)<span class="sc">$</span>tTable[<span class="st">"arm1"</span>,<span class="st">"Std.Error"</span>]</span>
<span id="cb72-180"><a href="#cb72-180" aria-hidden="true" tabindex="-1"></a>  t_adj <span class="ot">&lt;-</span> beta1_adj <span class="sc">/</span> se1_adj</span>
<span id="cb72-181"><a href="#cb72-181" aria-hidden="true" tabindex="-1"></a>  df_adj <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_ind<span class="sc">$</span>cluster)) <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">fixef</span>(model_adj))</span>
<span id="cb72-182"><a href="#cb72-182" aria-hidden="true" tabindex="-1"></a>  pval_adj <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pt</span>(<span class="sc">-</span><span class="fu">abs</span>(t_adj), <span class="at">df=</span>df_adj)</span>
<span id="cb72-183"><a href="#cb72-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-184"><a href="#cb72-184" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (6) Save results including OR and CI</span></span>
<span id="cb72-185"><a href="#cb72-185" aria-hidden="true" tabindex="-1"></a>  df1 <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_ind<span class="sc">$</span>cluster)) <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">fixef</span>(model_unadj))</span>
<span id="cb72-186"><a href="#cb72-186" aria-hidden="true" tabindex="-1"></a>  tval <span class="ot">&lt;-</span> <span class="fu">qt</span>(<span class="fl">0.975</span>, <span class="at">df=</span>df1)</span>
<span id="cb72-187"><a href="#cb72-187" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_unadj[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta1_unadj)</span>
<span id="cb72-188"><a href="#cb72-188" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_unadj_lower[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta1_unadj <span class="sc">-</span> tval <span class="sc">*</span> se1_unadj)</span>
<span id="cb72-189"><a href="#cb72-189" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_unadj_upper[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta1_unadj <span class="sc">+</span> tval <span class="sc">*</span> se1_unadj)</span>
<span id="cb72-190"><a href="#cb72-190" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-191"><a href="#cb72-191" aria-hidden="true" tabindex="-1"></a>  df_adj <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_ind<span class="sc">$</span>cluster)) <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">fixef</span>(model_adj))</span>
<span id="cb72-192"><a href="#cb72-192" aria-hidden="true" tabindex="-1"></a>  tval_adj <span class="ot">&lt;-</span> <span class="fu">qt</span>(<span class="fl">0.975</span>, <span class="at">df=</span>df_adj)</span>
<span id="cb72-193"><a href="#cb72-193" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_adj[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta1_adj)</span>
<span id="cb72-194"><a href="#cb72-194" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_adj_lower[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta1_adj <span class="sc">-</span> tval_adj <span class="sc">*</span> se1_adj)</span>
<span id="cb72-195"><a href="#cb72-195" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>OR_adj_upper[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta1_adj <span class="sc">+</span> tval_adj <span class="sc">*</span> se1_adj)</span>
<span id="cb72-196"><a href="#cb72-196" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-197"><a href="#cb72-197" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>unadj_signif[i] <span class="ot">&lt;-</span> (pval_unadj <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb72-198"><a href="#cb72-198" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>adj_signif[i]   <span class="ot">&lt;-</span> (pval_adj <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb72-199"><a href="#cb72-199" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-200"><a href="#cb72-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-201"><a href="#cb72-201" aria-hidden="true" tabindex="-1"></a><span class="co"># (7) Compute estimated power</span></span>
<span id="cb72-202"><a href="#cb72-202" aria-hidden="true" tabindex="-1"></a>power_unadj <span class="ot">&lt;-</span> <span class="fu">mean</span>(results<span class="sc">$</span>unadj_signif)</span>
<span id="cb72-203"><a href="#cb72-203" aria-hidden="true" tabindex="-1"></a>power_adj <span class="ot">&lt;-</span> <span class="fu">mean</span>(results<span class="sc">$</span>adj_signif)</span>
<span id="cb72-204"><a href="#cb72-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-205"><a href="#cb72-205" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated power (unadjusted)  ="</span>, <span class="fu">round</span>(power_unadj,<span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated power (unadjusted)  = 0.812 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated power (fully adjusted) ="</span>, <span class="fu">round</span>(power_adj,<span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated power (fully adjusted) = 0.898 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of ORs</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(results[,<span class="fu">c</span>(<span class="st">"OR_unadj"</span>,<span class="st">"OR_unadj_lower"</span>,<span class="st">"OR_unadj_upper"</span>,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"OR_adj"</span>,<span class="st">"OR_adj_lower"</span>,<span class="st">"OR_adj_upper"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    OR_unadj      OR_unadj_lower    OR_unadj_upper       OR_adj      
 Min.   :0.1046   Min.   :0.04464   Min.   :0.1899   Min.   :0.1031  
 1st Qu.:0.2654   1st Qu.:0.12211   1st Qu.:0.5589   1st Qu.:0.2650  
 Median :0.3331   Median :0.15774   Median :0.7104   Median :0.3382  
 Mean   :0.3640   Mean   :0.17311   Mean   :0.7789   Mean   :0.3540  
 3rd Qu.:0.4280   3rd Qu.:0.20877   3rd Qu.:0.9225   3rd Qu.:0.4173  
 Max.   :2.4694   Max.   :1.27878   Max.   :4.7687   Max.   :1.5219  
  OR_adj_lower     OR_adj_upper   
 Min.   :0.0448   Min.   :0.1883  
 1st Qu.:0.1373   1st Qu.:0.5042  
 Median :0.1738   Median :0.6477  
 Mean   :0.1869   Mean   :0.6808  
 3rd Qu.:0.2220   3rd Qu.:0.8124  
 Max.   :0.8044   Max.   :2.8793  </code></pre>
</div>
</div>
</section>
</section>
<section id="minimization-algorithm-for-stratified-randomization" class="level1">
<h1><strong>(4) Minimization algorithm for stratified randomization</strong></h1>
<p>Following the method proposed in [Xiao L, Yank V, Ma J. Algorithm for balancing both continuous and categorical covariates in randomized controlled trials.&nbsp;<em>Comput Methods Programs Biomed</em>. 2012;108(3):1185-1190. doi:10.1016/j.cmpb.2012.06.001](<a href="https://pubmed.ncbi.nlm.nih.gov/22727633/" class="uri">https://pubmed.ncbi.nlm.nih.gov/22727633/</a>)</p>
<p>They propose a modified symmetric Kullback–Leibler divergence (KLD) method to balance multi-arm trials. Works the same for a CRT if cluster-level covariates. The KLD method tries to balance both arm sizes and covariates dynamically (and prospectively) as clusters are assigned, but we can also use it with (a) fixed time-point of randomization and (b) fixed arm size (e.g.&nbsp;13:13:13), by setting Dn = 1 and p_Dn = 1. Enforcing such tight group-size balance while still allow minimization on covariates. In other words, it removes randomness in group totals but keeps balance across covariates =&gt; stratified randomization.</p>
<p>This has two disadvantages:</p>
<ol type="1">
<li>Randomization becomes more predictable (esp.&nbsp;towards the end of allocation)</li>
<li>Strict equal group sizes may slightly reduce the algorithm’s ability to optimize covariate balance, because sometimes the “best” assignment for covariates would tip the arm sizes temporarily, esp.&nbsp;in case of small number of clusters.</li>
</ol>
<p>Number (1) is not a problem in our case since we randomize all at once. Number (2) is the best we can get.</p>
<p>The method works as follows: For the (n+1)th cluster: compute the “amount of imbalance” (using KLD imbalance score) assuming the cluster is assigned to each arm in turn, then bias toward the arm(s) with the smallest value. They recommend: Pk = c(0.8, 0.1, 0.1): the covariate-balance biased-coin probabilities. 80% chance of choosing the arm with the smallest imbalance, 10% chance for the second-smallest, 10% chance for the worst. If all three arms tie, then average all slots (0.8+0.1+0.1)/3 = 0.333 (simple randomization)</p>
<p>Dn: maximum tolerated size imbalance before intervening</p>
<p>p_Dn: probability of forcing assignment to the smallest group once that imbalance is exceeded</p>
<ul>
<li>if any arm is ahead by ≥1 cluster, the next cluster is forced to the smallest arm. The “numbers-balance” rule (Sec. 2.3); they introduce p_Dn to reduce predictability vs.&nbsp;setting it to 1, but allow either.</li>
</ul>
<p>The first 2 sequences (here 6 clusters) are allocated as a permuted block - two per arm - before using minimization. This ensures early variance estimates exist for the KLD and mirrors the recommended start.</p>
<p>The symmetric-KLD part assumes approximate normality for continuous covariates (but they note high robustness even in case of violation)</p>
<p>We demonstrate it on a hypothetical allocation dataset, but will eventually feed the same code with the real allocation dataset.</p>
<p>Structure of allocation dataset:</p>
<ol type="1">
<li>cluster_id: 1-39</li>
<li>antibiotic_rate
<ul>
<li><p>Definition: Patients receiving an antibiotic prescription among all presenting at the participating cluster. Mean over past year?</p></li>
<li><p>Proportion, ranging from 0.44-0.87</p></li>
</ul></li>
<li>attendance_rate
<ul>
<li><p>All patients presenting at the participating cluster, per month, mean over past year</p></li>
<li><p>Absolute count, ranging from 200-2000</p></li>
</ul></li>
<li>island
<ul>
<li>Pemba vs Unguja</li>
<li>30:70</li>
</ul></li>
<li>arm: allocation 1-3</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20250820</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create hypothetical allocation dataset</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>n_clusters <span class="ot">&lt;-</span> <span class="dv">39</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>cluster_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_id =</span> <span class="dv">1</span><span class="sc">:</span>n_clusters,</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">antibiotic_rate =</span> <span class="fu">runif</span>(n_clusters, <span class="fl">0.44</span>, <span class="fl">0.87</span>),</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">attendance_rate =</span> <span class="fu">sample</span>(<span class="dv">200</span><span class="sc">:</span><span class="dv">2000</span>, n_clusters, <span class="cn">TRUE</span>),</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">island =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(<span class="fu">rbinom</span>(n_clusters, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.3</span>) <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Pemba"</span>, <span class="st">"Unguja"</span>))</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cluster_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   cluster_id antibiotic_rate attendance_rate island
1           1       0.8175535             389 Unguja
2           2       0.4593160             652 Unguja
3           3       0.8621713             372 Unguja
4           4       0.7707444             604  Pemba
5           5       0.4551056            1254  Pemba
6           6       0.6258714             329 Unguja
7           7       0.6704471            1587 Unguja
8           8       0.4909854            1300 Unguja
9           9       0.4857333            1092 Unguja
10         10       0.8505579             615 Unguja
11         11       0.6766742             827  Pemba
12         12       0.4758405            1220  Pemba
13         13       0.4410584             220 Unguja
14         14       0.7559218            1209  Pemba
15         15       0.4635024             546 Unguja
16         16       0.5350358             351 Unguja
17         17       0.8120696            1227  Pemba
18         18       0.7226116             902 Unguja
19         19       0.5457951            1321 Unguja
20         20       0.6043556            1405 Unguja
21         21       0.4889210             561 Unguja
22         22       0.7520059            1124  Pemba
23         23       0.8496349            1692  Pemba
24         24       0.5743991            1941 Unguja
25         25       0.5006325            1005 Unguja
26         26       0.8609247            1735  Pemba
27         27       0.8012171            1581 Unguja
28         28       0.5604527            1544 Unguja
29         29       0.8319907            1630 Unguja
30         30       0.4641657            1164  Pemba
31         31       0.5750356            1382 Unguja
32         32       0.8478091            1822 Unguja
33         33       0.7960053             683 Unguja
34         34       0.4691478            1317  Pemba
35         35       0.5454399             463 Unguja
36         36       0.7230553            1044 Unguja
37         37       0.7860256             968  Pemba
38         38       0.7082810            1777 Unguja
39         39       0.6951461             469 Unguja</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for minimization</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>n_arms <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>Dn <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>p_Dn <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>Pk <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Symmetric KLD for continuous covariates</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co"># the mean-difference term scaled by inverse variances plus a variance-term, summed over covariates, with the 0.5 factor (Eq. (1), continuous part). A tiny eps stabilizes near-zero variances.</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>symKLD_cont <span class="ot">&lt;-</span> <span class="cf">function</span>(Xi, Xj, <span class="at">eps =</span> <span class="fl">1e-8</span>) {</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Xi, Xj : matrices with columns = continuous covariates</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>  mu_i <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Xi)</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  mu_j <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Xj)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  v_i  <span class="ot">&lt;-</span> <span class="fu">apply</span>(Xi, <span class="dv">2</span>, var)</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  v_j  <span class="ot">&lt;-</span> <span class="fu">apply</span>(Xj, <span class="dv">2</span>, var)</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stabilize in case of near-constant covariate within an arm</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>  v_i  <span class="ot">&lt;-</span> <span class="fu">pmax</span>(v_i, eps)</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  v_j  <span class="ot">&lt;-</span> <span class="fu">pmax</span>(v_j, eps)</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>  term_mu  <span class="ot">&lt;-</span> ((mu_i <span class="sc">-</span> mu_j)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> v_i <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> v_j)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>  term_var <span class="ot">&lt;-</span> (v_i <span class="sc">+</span> v_j) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> v_i <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> v_j) <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 0.5 * sum over covariates</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">sum</span>(term_mu <span class="sc">+</span> term_var)</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a><span class="do">## Symmetric KLD for categorical variables</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>symKLD_cat <span class="ot">&lt;-</span> <span class="cf">function</span>(fac_i, fac_j, <span class="at">eps =</span> <span class="fl">1e-8</span>) {</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>  cats <span class="ot">&lt;-</span> <span class="fu">levels</span>(<span class="fu">factor</span>(<span class="fu">c</span>(fac_i, fac_j)))</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>  p_i <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(<span class="fu">table</span>(<span class="fu">factor</span>(fac_i, <span class="at">levels =</span> cats)))</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>  p_j <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(<span class="fu">table</span>(<span class="fu">factor</span>(fac_j, <span class="at">levels =</span> cats)))</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>  p_i <span class="ot">&lt;-</span> <span class="fu">pmax</span>(p_i, eps)</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>  p_j <span class="ot">&lt;-</span> <span class="fu">pmax</span>(p_j, eps)</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span> <span class="sc">*</span> (<span class="fu">sum</span>(p_i <span class="sc">*</span> <span class="fu">log</span>(p_i <span class="sc">/</span> p_j)) <span class="sc">+</span> <span class="fu">sum</span>(p_j <span class="sc">*</span> <span class="fu">log</span>(p_j <span class="sc">/</span> p_i)))</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a><span class="do">## Combined imbalance measure</span></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>symKLD_mixed <span class="ot">&lt;-</span> <span class="cf">function</span>(Xi, Xj, <span class="at">cont_vars =</span> <span class="fu">character</span>(<span class="dv">0</span>), <span class="at">cat_vars =</span> <span class="fu">character</span>(<span class="dv">0</span>)) {</span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(cont_vars) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>    D <span class="ot">&lt;-</span> D <span class="sc">+</span> <span class="fu">symKLD_cont</span>(Xi[, cont_vars, <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>                         Xj[, cont_vars, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(cat_vars) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (v <span class="cf">in</span> cat_vars) {</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>      D <span class="ot">&lt;-</span> D <span class="sc">+</span> <span class="fu">symKLD_cat</span>(Xi[[v]], Xj[[v]])</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>  D</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a><span class="do">## Total imbalance function using mixed covariates</span></span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a><span class="do">## Multi-arm extension and “what-if” evaluation (Sec. 2.1–2.4)</span></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a><span class="co"># For the (n+1)th cluster: compute the “amount of imbalance” assuming the cluster is assigned to each arm in turn, then bias toward the arm(s) with the smallest value (Algorithm Step 4; di construction extended to T &gt; 2 arms). The function pretends to assign the cluster to arm g and sums the pairwise KLDs across all unordered arm pairs under that hypothetical allocation. Terms not affected by the placement cancel in comparisons, so minimizing this total is equivalent to minimizing the paper’s di ranking.</span></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>total_imbalance_if <span class="ot">&lt;-</span> <span class="cf">function</span>(alloc, data, idx, g, n_arms,</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>                               <span class="at">cont_vars =</span> <span class="fu">character</span>(<span class="dv">0</span>), <span class="at">cat_vars =</span> <span class="fu">character</span>(<span class="dv">0</span>)) {</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> alloc</span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>  tmp[idx] <span class="ot">&lt;-</span> g</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>  arm_X <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n_arms, <span class="cf">function</span>(a) data[tmp <span class="sc">==</span> a, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(n_arms <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> (i <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n_arms) {</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(arm_X[[i]]) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(arm_X[[j]]) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>        D <span class="ot">&lt;-</span> D <span class="sc">+</span> <span class="fu">symKLD_mixed</span>(arm_X[[i]], arm_X[[j]],</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>                              cont_vars, cat_vars)</span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>        D <span class="ot">&lt;-</span> D <span class="sc">+</span> <span class="fl">1e6</span>  <span class="co"># small penalty if too few per arm</span></span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>  D</span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a><span class="do">## convert imbalance vector d_i to assignment probabilities with proper tie-averaging</span></span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a><span class="co"># smaller di ⇒ larger probability; if multiple arms tie, average the corresponding P_k positions so tied arms receive the same probability (Sec. 2.2). Normalizing ensures a proper probability vector.</span></span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>probs_from_di <span class="ot">&lt;-</span> <span class="cf">function</span>(di, Pk) {</span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(di)</span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">order</span>(di)<span class="co"># ranks by increasing imbalance</span></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>  probs <span class="ot">&lt;-</span> <span class="fu">numeric</span>(K)</span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>  pos <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (tie <span class="cf">in</span> <span class="fu">split</span>(o, di[o])) {</span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">&lt;-</span> <span class="fu">length</span>(tie)</span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slots for this tie = pos...(pos+k-1)</span></span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>    probs[tie] <span class="ot">&lt;-</span> <span class="fu">mean</span>(Pk[pos<span class="sc">:</span>(pos <span class="sc">+</span> k <span class="sc">-</span> <span class="dv">1</span>)])</span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> k</span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># normalize, just in case rounding makes probs not sum exactly to 1</span></span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>  probs <span class="sc">/</span> <span class="fu">sum</span>(probs)</span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a><span class="do">## main randomization</span></span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a>alloc <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_clusters)</span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a><span class="do">## Start with permuted block (first 2T = 6 clusters: 2 per arm)</span></span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a>init_ids <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_clusters, <span class="dv">2</span> <span class="sc">*</span> n_arms)</span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a>alloc[init_ids] <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_arms, <span class="at">each=</span><span class="dv">2</span>)</span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a><span class="do">## MAIN LOOP</span></span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a>cont_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"antibiotic_rate"</span>, <span class="st">"attendance_rate"</span>)</span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a>cat_vars  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"island"</span>)  <span class="co"># your new binary covariate</span></span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Remaining clusters to allocate</span></span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>remaining <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n_clusters, <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(alloc)))</span>
<span id="cb80-101"><a href="#cb80-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-102"><a href="#cb80-102" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (cl <span class="cf">in</span> remaining) {</span>
<span id="cb80-103"><a href="#cb80-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># current group-size imbalance (ignore NA entries)</span></span>
<span id="cb80-104"><a href="#cb80-104" aria-hidden="true" tabindex="-1"></a>  group_sizes <span class="ot">&lt;-</span> <span class="fu">tabulate</span>(alloc[<span class="sc">!</span><span class="fu">is.na</span>(alloc)], <span class="at">nbins =</span> n_arms)</span>
<span id="cb80-105"><a href="#cb80-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># group_sizes &lt;- tabulate(factor(alloc, levels = 1:n_arms), nbins = n_arms)</span></span>
<span id="cb80-106"><a href="#cb80-106" aria-hidden="true" tabindex="-1"></a>  max_diff <span class="ot">&lt;-</span> <span class="fu">max</span>(group_sizes) <span class="sc">-</span> <span class="fu">min</span>(group_sizes)</span>
<span id="cb80-107"><a href="#cb80-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-108"><a href="#cb80-108" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (max_diff <span class="sc">&gt;=</span> Dn) {</span>
<span id="cb80-109"><a href="#cb80-109" aria-hidden="true" tabindex="-1"></a>    min_group <span class="ot">&lt;-</span> <span class="fu">which.min</span>(group_sizes)</span>
<span id="cb80-110"><a href="#cb80-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> p_Dn) {</span>
<span id="cb80-111"><a href="#cb80-111" aria-hidden="true" tabindex="-1"></a>      alloc[cl] <span class="ot">&lt;-</span> min_group</span>
<span id="cb80-112"><a href="#cb80-112" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb80-113"><a href="#cb80-113" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-114"><a href="#cb80-114" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-115"><a href="#cb80-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-116"><a href="#cb80-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute D_i (hypothetical imbalances) for assigning this cluster to each arm</span></span>
<span id="cb80-117"><a href="#cb80-117" aria-hidden="true" tabindex="-1"></a>  di <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>n_arms, <span class="cf">function</span>(g)</span>
<span id="cb80-118"><a href="#cb80-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">total_imbalance_if</span>(alloc, cluster_data, cl, g, n_arms,</span>
<span id="cb80-119"><a href="#cb80-119" aria-hidden="true" tabindex="-1"></a>                     cont_vars, cat_vars))</span>
<span id="cb80-120"><a href="#cb80-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-121"><a href="#cb80-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Translate to assignment probabilities with tie-averaging -&gt; Pk probabilities</span></span>
<span id="cb80-122"><a href="#cb80-122" aria-hidden="true" tabindex="-1"></a>  prob_vec <span class="ot">&lt;-</span> <span class="fu">probs_from_di</span>(di, Pk)</span>
<span id="cb80-123"><a href="#cb80-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-124"><a href="#cb80-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Safety fallback</span></span>
<span id="cb80-125"><a href="#cb80-125" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If for some reason prob_vec is invalid (all zeros, or has NA), then the algorithm falls back to equal randomization (1/3 each)</span></span>
<span id="cb80-126"><a href="#cb80-126" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(prob_vec <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.na</span>(prob_vec))) {</span>
<span id="cb80-127"><a href="#cb80-127" aria-hidden="true" tabindex="-1"></a>    prob_vec <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>n_arms, n_arms)</span>
<span id="cb80-128"><a href="#cb80-128" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-129"><a href="#cb80-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-130"><a href="#cb80-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign cluster using these probabilities</span></span>
<span id="cb80-131"><a href="#cb80-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is the actual biased-coin randomization step; chooses one of the arms 1, 2, 3, according to prob_vec</span></span>
<span id="cb80-132"><a href="#cb80-132" aria-hidden="true" tabindex="-1"></a>  alloc[cl] <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(n_arms, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prob_vec)</span>
<span id="cb80-133"><a href="#cb80-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-134"><a href="#cb80-134" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-135"><a href="#cb80-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-136"><a href="#cb80-136" aria-hidden="true" tabindex="-1"></a><span class="co"># attach allocation</span></span>
<span id="cb80-137"><a href="#cb80-137" aria-hidden="true" tabindex="-1"></a>cluster_data<span class="sc">$</span>arm <span class="ot">&lt;-</span> alloc</span>
<span id="cb80-138"><a href="#cb80-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-139"><a href="#cb80-139" aria-hidden="true" tabindex="-1"></a><span class="co"># quick sanity check</span></span>
<span id="cb80-140"><a href="#cb80-140" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cluster_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   cluster_id antibiotic_rate attendance_rate island arm
1           1       0.8175535             389 Unguja   2
2           2       0.4593160             652 Unguja   1
3           3       0.8621713             372 Unguja   3
4           4       0.7707444             604  Pemba   1
5           5       0.4551056            1254  Pemba   2
6           6       0.6258714             329 Unguja   3
7           7       0.6704471            1587 Unguja   2
8           8       0.4909854            1300 Unguja   1
9           9       0.4857333            1092 Unguja   3
10         10       0.8505579             615 Unguja   2
11         11       0.6766742             827  Pemba   2
12         12       0.4758405            1220  Pemba   1
13         13       0.4410584             220 Unguja   3
14         14       0.7559218            1209  Pemba   1
15         15       0.4635024             546 Unguja   3
16         16       0.5350358             351 Unguja   1
17         17       0.8120696            1227  Pemba   3
18         18       0.7226116             902 Unguja   2
19         19       0.5457951            1321 Unguja   1
20         20       0.6043556            1405 Unguja   2
21         21       0.4889210             561 Unguja   2
22         22       0.7520059            1124  Pemba   3
23         23       0.8496349            1692  Pemba   2
24         24       0.5743991            1941 Unguja   3
25         25       0.5006325            1005 Unguja   1
26         26       0.8609247            1735  Pemba   1
27         27       0.8012171            1581 Unguja   3
28         28       0.5604527            1544 Unguja   1
29         29       0.8319907            1630 Unguja   2
30         30       0.4641657            1164  Pemba   3
31         31       0.5750356            1382 Unguja   1
32         32       0.8478091            1822 Unguja   2
33         33       0.7960053             683 Unguja   3
34         34       0.4691478            1317  Pemba   3
35         35       0.5454399             463 Unguja   1
36         36       0.7230553            1044 Unguja   2
37         37       0.7860256             968  Pemba   2
38         38       0.7082810            1777 Unguja   1
39         39       0.6951461             469 Unguja   3</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">table</span>(cluster_data<span class="sc">$</span>arm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
 1  2  3 
13 13 13 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">aggregate</span>(cluster_data[, <span class="fu">c</span>(<span class="st">"antibiotic_rate"</span>, <span class="st">"attendance_rate"</span>)],</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="fu">list</span>(<span class="at">arm =</span> cluster_data<span class="sc">$</span>arm), mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  arm antibiotic_rate attendance_rate
1   1       0.5988004       1120.2308
2   2       0.7172879       1130.4615
3   3       0.6340379        928.0769</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>island_table <span class="ot">&lt;-</span> <span class="fu">table</span>(cluster_data<span class="sc">$</span>arm, cluster_data<span class="sc">$</span>island)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>island_prop <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(island_table, <span class="at">margin =</span> <span class="dv">1</span>)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">t</span>(island_prop),</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">beside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>),</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="cn">TRUE</span>,</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">args.legend =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Island"</span>, <span class="at">x =</span> <span class="st">"topright"</span>),</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Arm"</span>, <span class="at">ylab =</span> <span class="st">"Proportion"</span>, <span class="at">main =</span> <span class="st">"Island distribution across arms"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="MOCA-DAWA_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>